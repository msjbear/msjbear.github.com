<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Spark," />





  <link rel="alternate" href="/atom.xml" title="BigBear's Blog" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/uploads/favicon.ico?v=5.1.1" />






<meta name="description" content="由于对spark-submit提交后执行流程比较好奇，所以研究了一下spark源码，以下算是阅读笔记吧。 spark-submit启动脚本： shell -z判断参数是否为空； $@：表示所有参数；$?：表示上一次程序返回值 使用@ 或可以获取数组中的所有元素，例如：${array_name[]}，${array_name[@]} SparkSubmit–&amp;gt;yarn/Client–&amp;gt;A">
<meta name="keywords" content="Spark">
<meta property="og:type" content="article">
<meta property="og:title" content="Spark Submit任务提交过程源码分析">
<meta property="og:url" content="http://yoursite.com/2016/09/25/spark-submit/index.html">
<meta property="og:site_name" content="BigBear&#39;s Blog">
<meta property="og:description" content="由于对spark-submit提交后执行流程比较好奇，所以研究了一下spark源码，以下算是阅读笔记吧。 spark-submit启动脚本： shell -z判断参数是否为空； $@：表示所有参数；$?：表示上一次程序返回值 使用@ 或可以获取数组中的所有元素，例如：${array_name[]}，${array_name[@]} SparkSubmit–&amp;gt;yarn/Client–&amp;gt;A">
<meta property="og:updated_time" content="2017-06-18T07:41:51.234Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Spark Submit任务提交过程源码分析">
<meta name="twitter:description" content="由于对spark-submit提交后执行流程比较好奇，所以研究了一下spark源码，以下算是阅读笔记吧。 spark-submit启动脚本： shell -z判断参数是否为空； $@：表示所有参数；$?：表示上一次程序返回值 使用@ 或可以获取数组中的所有元素，例如：${array_name[]}，${array_name[@]} SparkSubmit–&amp;gt;yarn/Client–&amp;gt;A">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"always","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2016/09/25/spark-submit/"/>





  <title>Spark Submit任务提交过程源码分析 | BigBear's Blog</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?35cbf8977b0279ea11c9f0c2bb4023f8";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">BigBear's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Do The Right Thing!</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            公益404
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-categories " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/09/25/spark-submit/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sj_mei">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BigBear's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Spark Submit任务提交过程源码分析</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-09-25T22:00:00+08:00">
                2016-09-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spark/" itemprop="url" rel="index">
                    <span itemprop="name">Spark</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a class="cloud-tie-join-count" href="/2016/09/25/spark-submit/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count join-count" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2016/09/25/spark-submit/" class="leancloud_visitors" data-flag-title="Spark Submit任务提交过程源码分析">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="330" height="86" src="http://music.163.com/outchain/player?type=2&id=28947001&auto=1&height=66"></iframe><br>由于对spark-submit提交后执行流程比较好奇，所以研究了一下spark源码，以下算是阅读笔记吧。</p>
<h2 id="spark-submit启动脚本："><a href="#spark-submit启动脚本：" class="headerlink" title="spark-submit启动脚本："></a>spark-submit启动脚本：</h2><ul>
<li>shell -z判断参数是否为空； $@：表示所有参数；$?：表示上一次程序返回值</li>
<li>使用@ 或<em>可以获取数组中的所有元素，例如：${array_name[</em>]}，${array_name[@]}</li>
<li>SparkSubmit–&gt;yarn/Client–&gt;ApplicationMaster<ul>
<li>Client：负责提交作业到Master。</li>
<li>Master：接收Client提交的作业，管理Worker，并命令Worker启动Driver和Executor。</li>
<li>Worker：负责管理本节点的资源，定期向Master汇报心跳，接收Master的命令，比如启动Driver和Executor。</li>
</ul>
</li>
<li>shell read可以带有-a, -d, -e, -n, -p, -r, -t, 和 -s八个选项。<figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">-<span class="ruby">a ：将内容读入到数值中</span></div><div class="line">-<span class="ruby">d ：表示delimiter，即定界符，一般情况下是以IFS为参数的间隔，但是通过-d，可以定义一直读到出现执行的字符位置。</span></div><div class="line">-<span class="ruby">n ：用于限定最多可以有多少字符可以作为有效读入。</span></div><div class="line">-<span class="ruby">p ：用于给出提示符，在前面的例子中我们使用了echo –n “…“来给出提示符，可以使用read –p ‘… my promt?’value的方式只需一个语句来表示。</span></div><div class="line">-<span class="ruby">r ：在参数输入中，我们可以使用’/’表示没有输入完，换行继续输入。</span></div><div class="line">-<span class="ruby">s ：对于一些特殊的符号，例如箭头号，不将他们在terminal上打印，我们按光标，在回车之后，如果要求显示，即echo，光标向上，如果不使用-s，在输入时，输入处显示^[[A，即在terminal上打印，之后如果要求echo，光标会上移。</span></div><div class="line">-<span class="ruby">t ：用于表示等待输入的时间，单位为秒，等待时间超过，将继续执行后面的脚本，注意不作为null输入，参数将保留原有的值</span></div></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">exec <span class="string">"$&#123;SPARK_HOME&#125;"</span>/bin/spark-class org<span class="selector-class">.apache</span><span class="selector-class">.spark</span><span class="selector-class">.deploy</span><span class="selector-class">.SparkSubmit</span> <span class="string">"$@"</span></div></pre></td></tr></table></figure>
<ul>
<li>spark-class代码(配置spark任务执行环境变量，提交执行程序)：<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">. "$&#123;SPARK_HOME&#125;"/bin/load-spark-env.sh</div><div class="line">build_command() &#123;</div><div class="line">  "$RUNNER" -Xmx128m -cp "$LAUNCH_CLASSPATH" org.apache.spark.launcher.Main "$@"</div><div class="line">  printf "%d\0" $?</div><div class="line">&#125;</div><div class="line"></div><div class="line">//解析参数</div><div class="line">CMD=()</div><div class="line">while IFS= read -d '' -r ARG; do</div><div class="line">  CMD+=("$ARG")</div><div class="line">done &lt; &lt;(build_command "$@")</div><div class="line"></div><div class="line">COUNT=$&#123;#CMD[@]&#125;</div><div class="line">LAST=$((COUNT - 1))</div><div class="line">LAUNCHER_EXIT_CODE=$&#123;CMD[$LAST]&#125;</div><div class="line">if [ $LAUNCHER_EXIT_CODE != 0 ]; then</div><div class="line">  exit $LAUNCHER_EXIT_CODE</div><div class="line">fi</div><div class="line"></div><div class="line">CMD=("$&#123;CMD[@]:0:$LAST&#125;")</div><div class="line">exec "$&#123;CMD[@]&#125;"</div><div class="line"></div><div class="line">exec "$&#123;CMD[@]&#125;"，即执行java -Xmx128m -cp "$LAUNCH_CLASSPATH" org.apache.spark.deploy.SparkSubmit "$@"，最终执行代码示例：</div><div class="line">/software/servers/jdk1.7.0_67/bin/java -cp /software/servers/druid/mart_risk/hadoop/lib/native/:/software/servers/druid/mart_risk/hadoop/share/hadoop/common/lib/hadoop-lzo-0.4.20.jar:/software/conf/druid/mart_risk/bdp_jmart_risk.bdp_jmart_risk_hkh/hive_conf/:/home/mart_risk/data_dir/sjmei/plugins/spark_2.0/conf/:/home/mart_risk/data_dir/sjmei/plugins/spark_2.0/jars/*:/software/conf/druid/mart_risk/bdp_jmart_risk.bdp_jmart_risk_hkh/hadoop_conf/ -XX:MaxPermSize=256m org.apache.spark.deploy.SparkSubmit --master yarn --deploy-mode cluster --conf spark.driver.memory=10g --properties-file ./conf/spark-defaults.conf --class com.jd.risk.dm.spark.ml.alphago.GBTMLlib --name spark gbt algo for devices --num-executors 10 --executor-memory 10g --executor-cores 2 --jars ./examples/jars/scopt_2.11-3.3.0.jar --queue bdp_jmart_risk.bdp_jmart_risk_hkh ./libs/jrdm-dm-2.0-SNAPSHOT.jar hdfs://ns2/user/mart_risk/dev.db/risk_jrdm_msj_devices_training_black training</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="deploy-SparkSubmit代码："><a href="#deploy-SparkSubmit代码：" class="headerlink" title="deploy.SparkSubmit代码："></a>deploy.SparkSubmit代码：</h2><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div><div class="line">411</div><div class="line">412</div><div class="line">413</div><div class="line">414</div><div class="line">415</div><div class="line">416</div><div class="line">417</div><div class="line">418</div><div class="line">419</div><div class="line">420</div><div class="line">421</div><div class="line">422</div><div class="line">423</div><div class="line">424</div><div class="line">425</div><div class="line">426</div><div class="line">427</div><div class="line">428</div><div class="line">429</div><div class="line">430</div><div class="line">431</div><div class="line">432</div><div class="line">433</div><div class="line">434</div><div class="line">435</div><div class="line">436</div><div class="line">437</div><div class="line">438</div><div class="line">439</div><div class="line">440</div><div class="line">441</div><div class="line">442</div><div class="line">443</div><div class="line">444</div><div class="line">445</div><div class="line">446</div><div class="line">447</div><div class="line">448</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</div><div class="line">    <span class="keyword">val</span> appArgs = <span class="keyword">new</span> <span class="type">SparkSubmitArguments</span>(args)</div><div class="line">    ...</div><div class="line">    appArgs.action <span class="keyword">match</span> &#123;</div><div class="line">      <span class="keyword">case</span> <span class="type">SparkSubmitAction</span>.<span class="type">SUBMIT</span> =&gt; submit(appArgs)</div><div class="line">      <span class="keyword">case</span> <span class="type">SparkSubmitAction</span>.<span class="type">KILL</span> =&gt; kill(appArgs)</div><div class="line">      <span class="keyword">case</span> <span class="type">SparkSubmitAction</span>.<span class="type">REQUEST_STATUS</span> =&gt; requestStatus(appArgs)</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line"><span class="comment">/**</span></div><div class="line">   * Submit the application using the provided parameters.</div><div class="line">   * This runs in two steps. First, we prepare the launch environment by setting up</div><div class="line">   * the appropriate classpath, system properties, and application arguments for</div><div class="line">   * running the child main class based on the cluster manager and the deploy mode.</div><div class="line">   * Second, we use this launch environment to invoke the main method of the child</div><div class="line">   * main class.</div><div class="line">   */</div><div class="line">  <span class="meta">@tailrec</span></div><div class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">submit</span></span>(args: <span class="type">SparkSubmitArguments</span>): <span class="type">Unit</span> = &#123;</div><div class="line">    <span class="keyword">val</span> (childArgs, childClasspath, sysProps, childMainClass) = prepareSubmitEnvironment(args)</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">doRunMain</span></span>(): <span class="type">Unit</span> = &#123;</div><div class="line">      <span class="keyword">if</span> (args.proxyUser != <span class="literal">null</span>) &#123;</div><div class="line">        <span class="keyword">val</span> proxyUser = <span class="type">UserGroupInformation</span>.createProxyUser(args.proxyUser,</div><div class="line">          <span class="type">UserGroupInformation</span>.getCurrentUser())</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">          proxyUser.doAs(<span class="keyword">new</span> <span class="type">PrivilegedExceptionAction</span>[<span class="type">Unit</span>]() &#123;</div><div class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">run</span></span>(): <span class="type">Unit</span> = &#123;</div><div class="line">              runMain(childArgs, childClasspath, sysProps, childMainClass, args.verbose)</div><div class="line">            &#125;</div><div class="line">          &#125;)</div><div class="line">        &#125; <span class="keyword">catch</span> &#123;</div><div class="line">          ...</div><div class="line">        &#125;</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        runMain(childArgs, childClasspath, sysProps, childMainClass, args.verbose)</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">     <span class="comment">// In standalone cluster mode, there are two submission gateways:</span></div><div class="line">     <span class="comment">//   (1) The traditional RPC gateway using o.a.s.deploy.Client as a wrapper</span></div><div class="line">     <span class="comment">//   (2) The new REST-based gateway introduced in Spark 1.3</span></div><div class="line">     <span class="comment">// The latter is the default behavior as of Spark 1.3, but Spark submit will fail over</span></div><div class="line">     <span class="comment">// to use the legacy gateway if the master endpoint turns out to be not a REST server.</span></div><div class="line">    <span class="keyword">if</span> (args.isStandaloneCluster &amp;&amp; args.useRest) &#123;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">// scalastyle:off println</span></div><div class="line">        printStream.println(<span class="string">"Running Spark using the REST application submission protocol."</span>)</div><div class="line">        <span class="comment">// scalastyle:on println</span></div><div class="line">        doRunMain()</div><div class="line">      &#125; <span class="keyword">catch</span> &#123;</div><div class="line">          ...</div><div class="line">          args.useRest = <span class="literal">false</span></div><div class="line">          submit(args)</div><div class="line">      &#125;</div><div class="line">    <span class="comment">// In all other modes, just run the main class as prepared</span></div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      doRunMain()</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line"><span class="comment">/**</span></div><div class="line">   * Prepare the environment for submitting an application.</div><div class="line">   * This returns a 4-tuple:</div><div class="line">   *   (1) the arguments for the child process,</div><div class="line">   *   (2) a list of classpath entries for the child,</div><div class="line">   *   (3) a map of system properties, and</div><div class="line">   *   (4) the main class for the child</div><div class="line">   * Exposed for testing.</div><div class="line">   */</div><div class="line">  <span class="keyword">private</span>[deploy] <span class="function"><span class="keyword">def</span> <span class="title">prepareSubmitEnvironment</span></span>(args: <span class="type">SparkSubmitArguments</span>)</div><div class="line">      : (<span class="type">Seq</span>[<span class="type">String</span>], <span class="type">Seq</span>[<span class="type">String</span>], <span class="type">Map</span>[<span class="type">String</span>, <span class="type">String</span>], <span class="type">String</span>) = &#123;</div><div class="line">    <span class="comment">// Return values</span></div><div class="line">    <span class="keyword">val</span> childArgs = <span class="keyword">new</span> <span class="type">ArrayBuffer</span>[<span class="type">String</span>]()</div><div class="line">    <span class="keyword">val</span> childClasspath = <span class="keyword">new</span> <span class="type">ArrayBuffer</span>[<span class="type">String</span>]()</div><div class="line">    <span class="keyword">val</span> sysProps = <span class="keyword">new</span> <span class="type">HashMap</span>[<span class="type">String</span>, <span class="type">String</span>]()</div><div class="line">    <span class="keyword">var</span> childMainClass = <span class="string">""</span></div><div class="line"></div><div class="line">    <span class="comment">// Set the cluster manager</span></div><div class="line">    <span class="keyword">val</span> clusterManager: <span class="type">Int</span> = args.master <span class="keyword">match</span> &#123;</div><div class="line">      <span class="keyword">case</span> <span class="string">"yarn"</span> =&gt; <span class="type">YARN</span></div><div class="line">      <span class="keyword">case</span> <span class="string">"yarn-client"</span> | <span class="string">"yarn-cluster"</span> =&gt;</div><div class="line">        printWarning(<span class="string">s"Master <span class="subst">$&#123;args.master&#125;</span> is deprecated since 2.0."</span> +</div><div class="line">          <span class="string">" Please use master \"yarn\" with specified deploy mode instead."</span>)</div><div class="line">        <span class="type">YARN</span></div><div class="line">      <span class="keyword">case</span> m <span class="keyword">if</span> m.startsWith(<span class="string">"spark"</span>) =&gt; <span class="type">STANDALONE</span></div><div class="line">      <span class="keyword">case</span> m <span class="keyword">if</span> m.startsWith(<span class="string">"mesos"</span>) =&gt; <span class="type">MESOS</span></div><div class="line">      <span class="keyword">case</span> m <span class="keyword">if</span> m.startsWith(<span class="string">"local"</span>) =&gt; <span class="type">LOCAL</span></div><div class="line">      <span class="keyword">case</span> _ =&gt;</div><div class="line">        printErrorAndExit(<span class="string">"Master must either be yarn or start with spark, mesos, local"</span>)</div><div class="line">        <span class="number">-1</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Set the deploy mode; default is client mode</span></div><div class="line">    <span class="keyword">var</span> deployMode: <span class="type">Int</span> = args.deployMode <span class="keyword">match</span> &#123;</div><div class="line">      <span class="keyword">case</span> <span class="string">"client"</span> | <span class="literal">null</span> =&gt; <span class="type">CLIENT</span></div><div class="line">      <span class="keyword">case</span> <span class="string">"cluster"</span> =&gt; <span class="type">CLUSTER</span></div><div class="line">      <span class="keyword">case</span> _ =&gt; printErrorAndExit(<span class="string">"Deploy mode must be either client or cluster"</span>); <span class="number">-1</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Because the deprecated way of specifying "yarn-cluster" and "yarn-client" encapsulate both</span></div><div class="line">    <span class="comment">// the master and deploy mode, we have some logic to infer the master and deploy mode</span></div><div class="line">    <span class="comment">// from each other if only one is specified, or exit early if they are at odds.</span></div><div class="line">    <span class="keyword">if</span> (clusterManager == <span class="type">YARN</span>) &#123;</div><div class="line">      (args.master, args.deployMode) <span class="keyword">match</span> &#123;</div><div class="line">        <span class="keyword">case</span> (<span class="string">"yarn-cluster"</span>, <span class="literal">null</span>) =&gt;</div><div class="line">          deployMode = <span class="type">CLUSTER</span></div><div class="line">          args.master = <span class="string">"yarn"</span></div><div class="line">        <span class="keyword">case</span> (<span class="string">"yarn-cluster"</span>, <span class="string">"client"</span>) =&gt;</div><div class="line">          printErrorAndExit(<span class="string">"Client deploy mode is not compatible with master \"yarn-cluster\""</span>)</div><div class="line">        <span class="keyword">case</span> (<span class="string">"yarn-client"</span>, <span class="string">"cluster"</span>) =&gt;</div><div class="line">          printErrorAndExit(<span class="string">"Cluster deploy mode is not compatible with master \"yarn-client\""</span>)</div><div class="line">        <span class="keyword">case</span> (_, mode) =&gt;</div><div class="line">          args.master = <span class="string">"yarn"</span></div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">// Make sure YARN is included in our build if we're trying to use it</span></div><div class="line">      <span class="keyword">if</span> (!<span class="type">Utils</span>.classIsLoadable(<span class="string">"org.apache.spark.deploy.yarn.Client"</span>) &amp;&amp; !<span class="type">Utils</span>.isTesting) &#123;</div><div class="line">        printErrorAndExit(</div><div class="line">          <span class="string">"Could not load YARN classes. "</span> +</div><div class="line">          <span class="string">"This copy of Spark may not have been compiled with YARN support."</span>)</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Update args.deployMode if it is null. It will be passed down as a Spark property later.</span></div><div class="line">    (args.deployMode, deployMode) <span class="keyword">match</span> &#123;</div><div class="line">      <span class="keyword">case</span> (<span class="literal">null</span>, <span class="type">CLIENT</span>) =&gt; args.deployMode = <span class="string">"client"</span></div><div class="line">      <span class="keyword">case</span> (<span class="literal">null</span>, <span class="type">CLUSTER</span>) =&gt; args.deployMode = <span class="string">"cluster"</span></div><div class="line">      <span class="keyword">case</span> _ =&gt;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">val</span> isYarnCluster = clusterManager == <span class="type">YARN</span> &amp;&amp; deployMode == <span class="type">CLUSTER</span></div><div class="line">    <span class="keyword">val</span> isMesosCluster = clusterManager == <span class="type">MESOS</span> &amp;&amp; deployMode == <span class="type">CLUSTER</span></div><div class="line"></div><div class="line">    <span class="comment">// Resolve maven dependencies if there are any and add classpath to jars. Add them to py-files</span></div><div class="line">    <span class="comment">// too for packages that include Python code</span></div><div class="line">    <span class="keyword">val</span> exclusions: <span class="type">Seq</span>[<span class="type">String</span>] =</div><div class="line">      <span class="keyword">if</span> (!<span class="type">StringUtils</span>.isBlank(args.packagesExclusions)) &#123;</div><div class="line">        args.packagesExclusions.split(<span class="string">","</span>)</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="type">Nil</span></div><div class="line">      &#125;</div><div class="line">    <span class="keyword">val</span> resolvedMavenCoordinates = <span class="type">SparkSubmitUtils</span>.resolveMavenCoordinates(args.packages,</div><div class="line">      <span class="type">Option</span>(args.repositories), <span class="type">Option</span>(args.ivyRepoPath), exclusions = exclusions)</div><div class="line">    <span class="keyword">if</span> (!<span class="type">StringUtils</span>.isBlank(resolvedMavenCoordinates)) &#123;</div><div class="line">      args.jars = mergeFileLists(args.jars, resolvedMavenCoordinates)</div><div class="line">      <span class="keyword">if</span> (args.isPython) &#123;</div><div class="line">        args.pyFiles = mergeFileLists(args.pyFiles, resolvedMavenCoordinates)</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// install any R packages that may have been passed through --jars or --packages.</span></div><div class="line">    <span class="comment">// Spark Packages may contain R source code inside the jar.</span></div><div class="line">    <span class="keyword">if</span> (args.isR &amp;&amp; !<span class="type">StringUtils</span>.isBlank(args.jars)) &#123;</div><div class="line">      <span class="type">RPackageUtils</span>.checkAndBuildRPackage(args.jars, printStream, args.verbose)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Require all python files to be local, so we can add them to the PYTHONPATH</span></div><div class="line">    <span class="comment">// In YARN cluster mode, python files are distributed as regular files, which can be non-local.</span></div><div class="line">    <span class="comment">// In Mesos cluster mode, non-local python files are automatically downloaded by Mesos.</span></div><div class="line">    <span class="keyword">if</span> (args.isPython &amp;&amp; !isYarnCluster &amp;&amp; !isMesosCluster) &#123;</div><div class="line">      <span class="keyword">if</span> (<span class="type">Utils</span>.nonLocalPaths(args.primaryResource).nonEmpty) &#123;</div><div class="line">        printErrorAndExit(<span class="string">s"Only local python files are supported: <span class="subst">$args</span>.primaryResource"</span>)</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">val</span> nonLocalPyFiles = <span class="type">Utils</span>.nonLocalPaths(args.pyFiles).mkString(<span class="string">","</span>)</div><div class="line">      <span class="keyword">if</span> (nonLocalPyFiles.nonEmpty) &#123;</div><div class="line">        printErrorAndExit(<span class="string">s"Only local additional python files are supported: <span class="subst">$nonLocalPyFiles</span>"</span>)</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Require all R files to be local</span></div><div class="line">    <span class="keyword">if</span> (args.isR &amp;&amp; !isYarnCluster) &#123;</div><div class="line">      <span class="keyword">if</span> (<span class="type">Utils</span>.nonLocalPaths(args.primaryResource).nonEmpty) &#123;</div><div class="line">        printErrorAndExit(<span class="string">s"Only local R files are supported: <span class="subst">$args</span>.primaryResource"</span>)</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// The following modes are not supported or applicable</span></div><div class="line">    (clusterManager, deployMode) <span class="keyword">match</span> &#123;</div><div class="line">      ...</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// If we're running a python app, set the main class to our specific python runner</span></div><div class="line">    <span class="keyword">if</span> (args.isPython &amp;&amp; deployMode == <span class="type">CLIENT</span>) &#123;</div><div class="line">      <span class="keyword">if</span> (args.primaryResource == <span class="type">PYSPARK_SHELL</span>) &#123;</div><div class="line">        args.mainClass = <span class="string">"org.apache.spark.api.python.PythonGatewayServer"</span></div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// If a python file is provided, add it to the child arguments and list of files to deploy.</span></div><div class="line">        <span class="comment">// Usage: PythonAppRunner &lt;main python file&gt; &lt;extra python files&gt; [app arguments]</span></div><div class="line">        args.mainClass = <span class="string">"org.apache.spark.deploy.PythonRunner"</span></div><div class="line">        args.childArgs = <span class="type">ArrayBuffer</span>(args.primaryResource, args.pyFiles) ++ args.childArgs</div><div class="line">        <span class="keyword">if</span> (clusterManager != <span class="type">YARN</span>) &#123;</div><div class="line">          <span class="comment">// The YARN backend distributes the primary file differently, so don't merge it.</span></div><div class="line">          args.files = mergeFileLists(args.files, args.primaryResource)</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (clusterManager != <span class="type">YARN</span>) &#123;</div><div class="line">        <span class="comment">// The YARN backend handles python files differently, so don't merge the lists.</span></div><div class="line">        args.files = mergeFileLists(args.files, args.pyFiles)</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (args.pyFiles != <span class="literal">null</span>) &#123;</div><div class="line">        sysProps(<span class="string">"spark.submit.pyFiles"</span>) = args.pyFiles</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// In YARN mode for an R app, add the SparkR package archive and the R package</span></div><div class="line">    <span class="comment">// archive containing all of the built R libraries to archives so that they can</span></div><div class="line">    <span class="comment">// be distributed with the job</span></div><div class="line">    ...</div><div class="line">    </div><div class="line">    <span class="comment">// Special flag to avoid deprecation warnings at the client</span></div><div class="line">    sysProps(<span class="string">"SPARK_SUBMIT"</span>) = <span class="string">"true"</span></div><div class="line"></div><div class="line">    <span class="comment">// A list of rules to map each argument to system properties or command-line options in</span></div><div class="line">    <span class="comment">// each deploy mode; we iterate through these below</span></div><div class="line">    <span class="keyword">val</span> options = <span class="type">List</span>[<span class="type">OptionAssigner</span>](</div><div class="line"></div><div class="line">      <span class="comment">// All cluster managers</span></div><div class="line">      <span class="type">OptionAssigner</span>(args.master, <span class="type">ALL_CLUSTER_MGRS</span>, <span class="type">ALL_DEPLOY_MODES</span>, sysProp = <span class="string">"spark.master"</span>),</div><div class="line">      <span class="type">OptionAssigner</span>(args.deployMode, <span class="type">ALL_CLUSTER_MGRS</span>, <span class="type">ALL_DEPLOY_MODES</span>,</div><div class="line">        sysProp = <span class="string">"spark.submit.deployMode"</span>),</div><div class="line">      <span class="type">OptionAssigner</span>(args.name, <span class="type">ALL_CLUSTER_MGRS</span>, <span class="type">ALL_DEPLOY_MODES</span>, sysProp = <span class="string">"spark.app.name"</span>),</div><div class="line">      <span class="type">OptionAssigner</span>(args.ivyRepoPath, <span class="type">ALL_CLUSTER_MGRS</span>, <span class="type">CLIENT</span>, sysProp = <span class="string">"spark.jars.ivy"</span>),</div><div class="line">      <span class="type">OptionAssigner</span>(args.driverMemory, <span class="type">ALL_CLUSTER_MGRS</span>, <span class="type">CLIENT</span>,</div><div class="line">        sysProp = <span class="string">"spark.driver.memory"</span>),</div><div class="line">      <span class="type">OptionAssigner</span>(args.driverExtraClassPath, <span class="type">ALL_CLUSTER_MGRS</span>, <span class="type">ALL_DEPLOY_MODES</span>,</div><div class="line">        sysProp = <span class="string">"spark.driver.extraClassPath"</span>),</div><div class="line">      <span class="type">OptionAssigner</span>(args.driverExtraJavaOptions, <span class="type">ALL_CLUSTER_MGRS</span>, <span class="type">ALL_DEPLOY_MODES</span>,</div><div class="line">        sysProp = <span class="string">"spark.driver.extraJavaOptions"</span>),</div><div class="line">      <span class="type">OptionAssigner</span>(args.driverExtraLibraryPath, <span class="type">ALL_CLUSTER_MGRS</span>, <span class="type">ALL_DEPLOY_MODES</span>,</div><div class="line">        sysProp = <span class="string">"spark.driver.extraLibraryPath"</span>),</div><div class="line"></div><div class="line">      <span class="comment">// Yarn only</span></div><div class="line">      <span class="type">OptionAssigner</span>(args.queue, <span class="type">YARN</span>, <span class="type">ALL_DEPLOY_MODES</span>, sysProp = <span class="string">"spark.yarn.queue"</span>),</div><div class="line">      <span class="type">OptionAssigner</span>(args.numExecutors, <span class="type">YARN</span>, <span class="type">ALL_DEPLOY_MODES</span>,</div><div class="line">        sysProp = <span class="string">"spark.executor.instances"</span>),</div><div class="line">      <span class="type">OptionAssigner</span>(args.jars, <span class="type">YARN</span>, <span class="type">ALL_DEPLOY_MODES</span>, sysProp = <span class="string">"spark.yarn.dist.jars"</span>),</div><div class="line">      <span class="type">OptionAssigner</span>(args.files, <span class="type">YARN</span>, <span class="type">ALL_DEPLOY_MODES</span>, sysProp = <span class="string">"spark.yarn.dist.files"</span>),</div><div class="line">      <span class="type">OptionAssigner</span>(args.archives, <span class="type">YARN</span>, <span class="type">ALL_DEPLOY_MODES</span>, sysProp = <span class="string">"spark.yarn.dist.archives"</span>),</div><div class="line">      <span class="type">OptionAssigner</span>(args.principal, <span class="type">YARN</span>, <span class="type">ALL_DEPLOY_MODES</span>, sysProp = <span class="string">"spark.yarn.principal"</span>),</div><div class="line">      <span class="type">OptionAssigner</span>(args.keytab, <span class="type">YARN</span>, <span class="type">ALL_DEPLOY_MODES</span>, sysProp = <span class="string">"spark.yarn.keytab"</span>),</div><div class="line"></div><div class="line">      <span class="comment">// Other options</span></div><div class="line">      <span class="type">OptionAssigner</span>(args.executorCores, <span class="type">STANDALONE</span> | <span class="type">YARN</span>, <span class="type">ALL_DEPLOY_MODES</span>,</div><div class="line">        sysProp = <span class="string">"spark.executor.cores"</span>),</div><div class="line">      <span class="type">OptionAssigner</span>(args.executorMemory, <span class="type">STANDALONE</span> | <span class="type">MESOS</span> | <span class="type">YARN</span>, <span class="type">ALL_DEPLOY_MODES</span>,</div><div class="line">        sysProp = <span class="string">"spark.executor.memory"</span>),</div><div class="line">      <span class="type">OptionAssigner</span>(args.totalExecutorCores, <span class="type">STANDALONE</span> | <span class="type">MESOS</span>, <span class="type">ALL_DEPLOY_MODES</span>,</div><div class="line">        sysProp = <span class="string">"spark.cores.max"</span>),</div><div class="line">      <span class="type">OptionAssigner</span>(args.files, <span class="type">LOCAL</span> | <span class="type">STANDALONE</span> | <span class="type">MESOS</span>, <span class="type">ALL_DEPLOY_MODES</span>,</div><div class="line">        sysProp = <span class="string">"spark.files"</span>),</div><div class="line">      <span class="type">OptionAssigner</span>(args.jars, <span class="type">LOCAL</span>, <span class="type">CLIENT</span>, sysProp = <span class="string">"spark.jars"</span>),</div><div class="line">      <span class="type">OptionAssigner</span>(args.jars, <span class="type">STANDALONE</span> | <span class="type">MESOS</span>, <span class="type">ALL_DEPLOY_MODES</span>, sysProp = <span class="string">"spark.jars"</span>),</div><div class="line">      <span class="type">OptionAssigner</span>(args.driverMemory, <span class="type">STANDALONE</span> | <span class="type">MESOS</span> | <span class="type">YARN</span>, <span class="type">CLUSTER</span>,</div><div class="line">        sysProp = <span class="string">"spark.driver.memory"</span>),</div><div class="line">      <span class="type">OptionAssigner</span>(args.driverCores, <span class="type">STANDALONE</span> | <span class="type">MESOS</span> | <span class="type">YARN</span>, <span class="type">CLUSTER</span>,</div><div class="line">        sysProp = <span class="string">"spark.driver.cores"</span>),</div><div class="line">      <span class="type">OptionAssigner</span>(args.supervise.toString, <span class="type">STANDALONE</span> | <span class="type">MESOS</span>, <span class="type">CLUSTER</span>,</div><div class="line">        sysProp = <span class="string">"spark.driver.supervise"</span>),</div><div class="line">      <span class="type">OptionAssigner</span>(args.ivyRepoPath, <span class="type">STANDALONE</span>, <span class="type">CLUSTER</span>, sysProp = <span class="string">"spark.jars.ivy"</span>)</div><div class="line">    )</div><div class="line"></div><div class="line">    <span class="comment">// In client mode, launch the application main class directly</span></div><div class="line">    <span class="comment">// In addition, add the main application jar and any added jars (if any) to the classpath</span></div><div class="line">    <span class="keyword">if</span> (deployMode == <span class="type">CLIENT</span>) &#123;</div><div class="line">      childMainClass = args.mainClass</div><div class="line">      <span class="keyword">if</span> (isUserJar(args.primaryResource)) &#123;</div><div class="line">        childClasspath += args.primaryResource</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (args.jars != <span class="literal">null</span>) &#123; childClasspath ++= args.jars.split(<span class="string">","</span>) &#125;</div><div class="line">      <span class="keyword">if</span> (args.childArgs != <span class="literal">null</span>) &#123; childArgs ++= args.childArgs &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Map all arguments to command-line options or system properties for our chosen mode</span></div><div class="line">    <span class="keyword">for</span> (opt &lt;- options) &#123;</div><div class="line">      <span class="keyword">if</span> (opt.value != <span class="literal">null</span> &amp;&amp;</div><div class="line">          (deployMode &amp; opt.deployMode) != <span class="number">0</span> &amp;&amp;</div><div class="line">          (clusterManager &amp; opt.clusterManager) != <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (opt.clOption != <span class="literal">null</span>) &#123; childArgs += (opt.clOption, opt.value) &#125;</div><div class="line">        <span class="keyword">if</span> (opt.sysProp != <span class="literal">null</span>) &#123; sysProps.put(opt.sysProp, opt.value) &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Add the application jar automatically so the user doesn't have to call sc.addJar</span></div><div class="line">    <span class="comment">// For YARN cluster mode, the jar is already distributed on each node as "app.jar"</span></div><div class="line">    <span class="comment">// For python and R files, the primary resource is already distributed as a regular file</span></div><div class="line">    <span class="keyword">if</span> (!isYarnCluster &amp;&amp; !args.isPython &amp;&amp; !args.isR) &#123;</div><div class="line">      <span class="keyword">var</span> jars = sysProps.get(<span class="string">"spark.jars"</span>).map(x =&gt; x.split(<span class="string">","</span>).toSeq).getOrElse(<span class="type">Seq</span>.empty)</div><div class="line">      <span class="keyword">if</span> (isUserJar(args.primaryResource)) &#123;</div><div class="line">        jars = jars ++ <span class="type">Seq</span>(args.primaryResource)</div><div class="line">      &#125;</div><div class="line">      sysProps.put(<span class="string">"spark.jars"</span>, jars.mkString(<span class="string">","</span>))</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// In standalone cluster mode, use the REST client to submit the application (Spark 1.3+).</span></div><div class="line">    <span class="comment">// All Spark parameters are expected to be passed to the client through system properties.</span></div><div class="line">    <span class="keyword">if</span> (args.isStandaloneCluster) &#123;</div><div class="line">      <span class="keyword">if</span> (args.useRest) &#123;</div><div class="line">        childMainClass = <span class="string">"org.apache.spark.deploy.rest.RestSubmissionClient"</span></div><div class="line">        childArgs += (args.primaryResource, args.mainClass)</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// In legacy standalone cluster mode, use Client as a wrapper around the user class</span></div><div class="line">        childMainClass = <span class="string">"org.apache.spark.deploy.Client"</span></div><div class="line">        <span class="keyword">if</span> (args.supervise) &#123; childArgs += <span class="string">"--supervise"</span> &#125;</div><div class="line">        <span class="type">Option</span>(args.driverMemory).foreach &#123; m =&gt; childArgs += (<span class="string">"--memory"</span>, m) &#125;</div><div class="line">        <span class="type">Option</span>(args.driverCores).foreach &#123; c =&gt; childArgs += (<span class="string">"--cores"</span>, c) &#125;</div><div class="line">        childArgs += <span class="string">"launch"</span></div><div class="line">        childArgs += (args.master, args.primaryResource, args.mainClass)</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (args.childArgs != <span class="literal">null</span>) &#123;</div><div class="line">        childArgs ++= args.childArgs</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Let YARN know it's a pyspark app, so it distributes needed libraries.</span></div><div class="line">    <span class="keyword">if</span> (clusterManager == <span class="type">YARN</span>) &#123;</div><div class="line">      <span class="keyword">if</span> (args.isPython) &#123;</div><div class="line">        sysProps.put(<span class="string">"spark.yarn.isPython"</span>, <span class="string">"true"</span>)</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (args.pyFiles != <span class="literal">null</span>) &#123;</div><div class="line">        sysProps(<span class="string">"spark.submit.pyFiles"</span>) = args.pyFiles</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// assure a keytab is available from any place in a JVM</span></div><div class="line">    <span class="keyword">if</span> (clusterManager == <span class="type">YARN</span> || clusterManager == <span class="type">LOCAL</span>) &#123;</div><div class="line">      <span class="keyword">if</span> (args.principal != <span class="literal">null</span>) &#123;</div><div class="line">        require(args.keytab != <span class="literal">null</span>, <span class="string">"Keytab must be specified when principal is specified"</span>)</div><div class="line">        <span class="keyword">if</span> (!<span class="keyword">new</span> <span class="type">File</span>(args.keytab).exists()) &#123;</div><div class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">SparkException</span>(<span class="string">s"Keytab file: <span class="subst">$&#123;args.keytab&#125;</span> does not exist"</span>)</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">          <span class="comment">// Add keytab and principal configurations in sysProps to make them available</span></div><div class="line">          <span class="comment">// for later use; e.g. in spark sql, the isolated class loader used to talk</span></div><div class="line">          <span class="comment">// to HiveMetastore will use these settings. They will be set as Java system</span></div><div class="line">          <span class="comment">// properties and then loaded by SparkConf</span></div><div class="line">          sysProps.put(<span class="string">"spark.yarn.keytab"</span>, args.keytab)</div><div class="line">          sysProps.put(<span class="string">"spark.yarn.principal"</span>, args.principal)</div><div class="line"></div><div class="line">          <span class="type">UserGroupInformation</span>.loginUserFromKeytab(args.principal, args.keytab)</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// In yarn-cluster mode, use yarn.Client as a wrapper around the user class</span></div><div class="line">    <span class="keyword">if</span> (isYarnCluster) &#123;</div><div class="line">      childMainClass = <span class="string">"org.apache.spark.deploy.yarn.Client"</span></div><div class="line">      <span class="keyword">if</span> (args.isPython) &#123;</div><div class="line">        childArgs += (<span class="string">"--primary-py-file"</span>, args.primaryResource)</div><div class="line">        childArgs += (<span class="string">"--class"</span>, <span class="string">"org.apache.spark.deploy.PythonRunner"</span>)</div><div class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (args.isR) &#123;</div><div class="line">        <span class="keyword">val</span> mainFile = <span class="keyword">new</span> <span class="type">Path</span>(args.primaryResource).getName</div><div class="line">        childArgs += (<span class="string">"--primary-r-file"</span>, mainFile)</div><div class="line">        childArgs += (<span class="string">"--class"</span>, <span class="string">"org.apache.spark.deploy.RRunner"</span>)</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">if</span> (args.primaryResource != <span class="type">SparkLauncher</span>.<span class="type">NO_RESOURCE</span>) &#123;</div><div class="line">          childArgs += (<span class="string">"--jar"</span>, args.primaryResource)</div><div class="line">        &#125;</div><div class="line">        childArgs += (<span class="string">"--class"</span>, args.mainClass)</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (args.childArgs != <span class="literal">null</span>) &#123;</div><div class="line">        args.childArgs.foreach &#123; arg =&gt; childArgs += (<span class="string">"--arg"</span>, arg) &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (isMesosCluster) &#123;</div><div class="line">      ...</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Load any properties specified through --conf and the default properties file</span></div><div class="line">    <span class="keyword">for</span> ((k, v) &lt;- args.sparkProperties) &#123;</div><div class="line">      sysProps.getOrElseUpdate(k, v)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Ignore invalid spark.driver.host in cluster modes.</span></div><div class="line">    <span class="keyword">if</span> (deployMode == <span class="type">CLUSTER</span>) &#123;</div><div class="line">      sysProps -= <span class="string">"spark.driver.host"</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Resolve paths in certain spark properties</span></div><div class="line">    <span class="keyword">val</span> pathConfigs = <span class="type">Seq</span>(</div><div class="line">      <span class="string">"spark.jars"</span>,</div><div class="line">      <span class="string">"spark.files"</span>,</div><div class="line">      <span class="string">"spark.yarn.dist.files"</span>,</div><div class="line">      <span class="string">"spark.yarn.dist.archives"</span>,</div><div class="line">      <span class="string">"spark.yarn.dist.jars"</span>)</div><div class="line">    pathConfigs.foreach &#123; config =&gt;</div><div class="line">      <span class="comment">// Replace old URIs with resolved URIs, if they exist</span></div><div class="line">      sysProps.get(config).foreach &#123; oldValue =&gt;</div><div class="line">        sysProps(config) = <span class="type">Utils</span>.resolveURIs(oldValue)</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Resolve and format python file paths properly before adding them to the PYTHONPATH.</span></div><div class="line">    <span class="comment">// The resolving part is redundant in the case of --py-files, but necessary if the user</span></div><div class="line">    <span class="comment">// explicitly sets `spark.submit.pyFiles` in his/her default properties file.</span></div><div class="line">    sysProps.get(<span class="string">"spark.submit.pyFiles"</span>).foreach &#123; pyFiles =&gt;</div><div class="line">      <span class="keyword">val</span> resolvedPyFiles = <span class="type">Utils</span>.resolveURIs(pyFiles)</div><div class="line">      <span class="keyword">val</span> formattedPyFiles = <span class="type">PythonRunner</span>.formatPaths(resolvedPyFiles).mkString(<span class="string">","</span>)</div><div class="line">      sysProps(<span class="string">"spark.submit.pyFiles"</span>) = formattedPyFiles</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    (childArgs, childClasspath, sysProps, childMainClass)</div><div class="line">  &#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">   * Run the main method of the child class using the provided launch environment.</div><div class="line">   * Note that this main class will not be the one provided by the user if we</div><div class="line">   * are running cluster deploy mode or python applications.</div><div class="line">   */</div><div class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">runMain</span></span>(</div><div class="line">      childArgs: <span class="type">Seq</span>[<span class="type">String</span>],</div><div class="line">      childClasspath: <span class="type">Seq</span>[<span class="type">String</span>],</div><div class="line">      sysProps: <span class="type">Map</span>[<span class="type">String</span>, <span class="type">String</span>],</div><div class="line">      childMainClass: <span class="type">String</span>,</div><div class="line">      verbose: <span class="type">Boolean</span>): <span class="type">Unit</span> = &#123;</div><div class="line">    <span class="keyword">if</span> (verbose) &#123;</div><div class="line">      printStream.println(<span class="string">s"Main class:\n<span class="subst">$childMainClass</span>"</span>)</div><div class="line">      printStream.println(<span class="string">s"Arguments:\n<span class="subst">$&#123;childArgs.mkString("\n")&#125;</span>"</span>)</div><div class="line">      printStream.println(<span class="string">s"System properties:\n<span class="subst">$&#123;sysProps.mkString("\n")&#125;</span>"</span>)</div><div class="line">      printStream.println(<span class="string">s"Classpath elements:\n<span class="subst">$&#123;childClasspath.mkString("\n")&#125;</span>"</span>)</div><div class="line">      printStream.println(<span class="string">"\n"</span>)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">val</span> loader =</div><div class="line">      <span class="keyword">if</span> (sysProps.getOrElse(<span class="string">"spark.driver.userClassPathFirst"</span>, <span class="string">"false"</span>).toBoolean) &#123;</div><div class="line">        <span class="keyword">new</span> <span class="type">ChildFirstURLClassLoader</span>(<span class="keyword">new</span> <span class="type">Array</span>[<span class="type">URL</span>](<span class="number">0</span>),</div><div class="line">          <span class="type">Thread</span>.currentThread.getContextClassLoader)</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">new</span> <span class="type">MutableURLClassLoader</span>(<span class="keyword">new</span> <span class="type">Array</span>[<span class="type">URL</span>](<span class="number">0</span>),</div><div class="line">          <span class="type">Thread</span>.currentThread.getContextClassLoader)</div><div class="line">      &#125;</div><div class="line">    <span class="type">Thread</span>.currentThread.setContextClassLoader(loader)</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (jar &lt;- childClasspath) &#123;</div><div class="line">      addJarToClasspath(jar, loader)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> ((key, value) &lt;- sysProps) &#123;</div><div class="line">      <span class="type">System</span>.setProperty(key, value)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> mainClass: <span class="type">Class</span>[_] = <span class="literal">null</span></div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      mainClass = <span class="type">Utils</span>.classForName(childMainClass)</div><div class="line">    &#125; <span class="keyword">catch</span> &#123;</div><div class="line">      ...</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h2 id="deploy-yarn-Client代码："><a href="#deploy-yarn-Client代码：" class="headerlink" title="deploy.yarn.Client代码："></a>deploy.yarn.Client代码：</h2><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(argStrings: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</div><div class="line">    <span class="keyword">if</span> (!sys.props.contains(<span class="string">"SPARK_SUBMIT"</span>)) &#123;</div><div class="line">      logWarning(<span class="string">"WARNING: This client is deprecated and will be removed in a "</span> +</div><div class="line">        <span class="string">"future version of Spark. Use ./bin/spark-submit with \"--master yarn\""</span>)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Set an env variable indicating we are running in YARN mode.</span></div><div class="line">    <span class="comment">// Note that any env variable with the SPARK_ prefix gets propagated to all (remote) processes</span></div><div class="line">    <span class="type">System</span>.setProperty(<span class="string">"SPARK_YARN_MODE"</span>, <span class="string">"true"</span>)</div><div class="line">    <span class="keyword">val</span> sparkConf = <span class="keyword">new</span> <span class="type">SparkConf</span></div><div class="line"></div><div class="line">    <span class="keyword">val</span> args = <span class="keyword">new</span> <span class="type">ClientArguments</span>(argStrings)</div><div class="line">    <span class="keyword">new</span> <span class="type">Client</span>(args, sparkConf).run()</div><div class="line">  &#125;</div><div class="line">  </div><div class="line"><span class="comment">/**</span></div><div class="line">   * Submit an application to the ResourceManager.</div><div class="line">   * If set spark.yarn.submit.waitAppCompletion to true, it will stay alive</div><div class="line">   * reporting the application's status until the application has exited for any reason.</div><div class="line">   * Otherwise, the client process will exit after submission.</div><div class="line">   * If the application finishes with a failed, killed, or undefined status,</div><div class="line">   * throw an appropriate SparkException.</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">run</span></span>(): <span class="type">Unit</span> = &#123;</div><div class="line">    <span class="keyword">this</span>.appId = submitApplication()</div><div class="line">    <span class="keyword">if</span> (!launcherBackend.isConnected() &amp;&amp; fireAndForget) &#123;</div><div class="line">      <span class="keyword">val</span> report = getApplicationReport(appId)<span class="comment">//ApplicationReport是应用程序的报告（包括程序用户、程序队列、程序名称等等）</span></div><div class="line">      <span class="keyword">val</span> state = report.getYarnApplicationState<span class="comment">//得到应用程序的完成状态</span></div><div class="line">      logInfo(<span class="string">s"Application report for <span class="subst">$appId</span> (state: <span class="subst">$state</span>)"</span>)</div><div class="line">      logInfo(formatReportDetails(report))</div><div class="line">      <span class="keyword">if</span> (state == <span class="type">YarnApplicationState</span>.<span class="type">FAILED</span> || state == <span class="type">YarnApplicationState</span>.<span class="type">KILLED</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">SparkException</span>(<span class="string">s"Application <span class="subst">$appId</span> finished with status: <span class="subst">$state</span>"</span>)</div><div class="line">      &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">//涉及两个对象YarnApplicationState（对于yarn来说任务的状态）、FinalApplicationStatus（对于任务来说任务的运行状态）</span></div><div class="line">      <span class="keyword">val</span> (yarnApplicationState, finalApplicationStatus) = monitorApplication(appId)</div><div class="line">      <span class="keyword">if</span> (yarnApplicationState == <span class="type">YarnApplicationState</span>.<span class="type">FAILED</span> ||</div><div class="line">        finalApplicationStatus == <span class="type">FinalApplicationStatus</span>.<span class="type">FAILED</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">SparkException</span>(<span class="string">s"Application <span class="subst">$appId</span> finished with failed status"</span>)</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (yarnApplicationState == <span class="type">YarnApplicationState</span>.<span class="type">KILLED</span> ||</div><div class="line">        finalApplicationStatus == <span class="type">FinalApplicationStatus</span>.<span class="type">KILLED</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">SparkException</span>(<span class="string">s"Application <span class="subst">$appId</span> is killed"</span>)</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (finalApplicationStatus == <span class="type">FinalApplicationStatus</span>.<span class="type">UNDEFINED</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">SparkException</span>(<span class="string">s"The final status of application <span class="subst">$appId</span> is undefined"</span>)</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line"> <span class="comment">/**</span></div><div class="line">   * Submit an application running our ApplicationMaster to the ResourceManager.</div><div class="line">   * The stable Yarn API provides a convenience method (YarnClient#createApplication) for</div><div class="line">   * creating applications and setting up the application submission context. This was not</div><div class="line">   * available in the alpha API.</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">submitApplication</span></span>(): <span class="type">ApplicationId</span> = &#123;</div><div class="line">    <span class="keyword">var</span> appId: <span class="type">ApplicationId</span> = <span class="literal">null</span></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      launcherBackend.connect()</div><div class="line">      <span class="comment">// Setup the credentials before doing anything else,</span></div><div class="line">      <span class="comment">// so we have don't have issues at any point.</span></div><div class="line">      setupCredentials()</div><div class="line">      yarnClient.init(yarnConf)</div><div class="line">      yarnClient.start()</div><div class="line"></div><div class="line">      logInfo(<span class="string">"Requesting a new application from cluster with %d NodeManagers"</span></div><div class="line">        .format(yarnClient.getYarnClusterMetrics.getNumNodeManagers))</div><div class="line"></div><div class="line">      <span class="comment">// Get a new application from our RM</span></div><div class="line">      <span class="keyword">val</span> newApp = yarnClient.createApplication()<span class="comment">// 构建ApplicationMaster的container(包括jar包路径 userClas等)</span></div><div class="line">      <span class="keyword">val</span> newAppResponse = newApp.getNewApplicationResponse()</div><div class="line">      appId = newAppResponse.getApplicationId()</div><div class="line">      reportLauncherState(<span class="type">SparkAppHandle</span>.<span class="type">State</span>.<span class="type">SUBMITTED</span>)</div><div class="line">      launcherBackend.setAppId(appId.toString)</div><div class="line"></div><div class="line">      <span class="comment">// Verify whether the cluster has enough resources for our AM</span></div><div class="line">      verifyClusterResources(newAppResponse)</div><div class="line"></div><div class="line">      <span class="comment">// Set up the appropriate contexts to launch our AM</span></div><div class="line">      <span class="keyword">val</span> containerContext = createContainerLaunchContext(newAppResponse)</div><div class="line">      <span class="keyword">val</span> appContext = createApplicationSubmissionContext(newApp, containerContext)</div><div class="line"></div><div class="line">      <span class="comment">// Finally, submit and monitor the application</span></div><div class="line">      logInfo(<span class="string">s"Submitting application <span class="subst">$appId</span> to ResourceManager"</span>)</div><div class="line">      yarnClient.submitApplication(appContext)</div><div class="line">      appId</div><div class="line">    &#125; <span class="keyword">catch</span> &#123;</div><div class="line">      ...</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">   * Set up a ContainerLaunchContext to launch our ApplicationMaster container.</div><div class="line">   * This sets up the launch environment, java options, and the command for launching the AM.</div><div class="line">   */</div><div class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">createContainerLaunchContext</span></span>(newAppResponse: <span class="type">GetNewApplicationResponse</span>)</div><div class="line">    : <span class="type">ContainerLaunchContext</span> = &#123;</div><div class="line">    logInfo(<span class="string">"Setting up container launch context for our AM"</span>)</div><div class="line">    <span class="keyword">val</span> appId = newAppResponse.getApplicationId</div><div class="line">    <span class="keyword">val</span> appStagingDirPath = <span class="keyword">new</span> <span class="type">Path</span>(appStagingBaseDir, getAppStagingDir(appId))</div><div class="line">    <span class="keyword">val</span> pySparkArchives =</div><div class="line">      <span class="keyword">if</span> (sparkConf.get(<span class="type">IS_PYTHON_APP</span>)) &#123;</div><div class="line">        findPySparkArchives()</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="type">Nil</span></div><div class="line">      &#125;</div><div class="line">    <span class="keyword">val</span> launchEnv = setupLaunchEnv(appStagingDirPath, pySparkArchives)</div><div class="line">    <span class="keyword">val</span> localResources = prepareLocalResources(appStagingDirPath, pySparkArchives)</div><div class="line"></div><div class="line">    <span class="keyword">val</span> amContainer = <span class="type">Records</span>.newRecord(classOf[<span class="type">ContainerLaunchContext</span>])</div><div class="line">    amContainer.setLocalResources(localResources.asJava)</div><div class="line">    amContainer.setEnvironment(launchEnv.asJava)</div><div class="line"></div><div class="line">    <span class="keyword">val</span> javaOpts = <span class="type">ListBuffer</span>[<span class="type">String</span>]()</div><div class="line"></div><div class="line">    <span class="comment">// Set the environment variable through a command prefix</span></div><div class="line">    <span class="comment">// to append to the existing value of the variable</span></div><div class="line">    <span class="keyword">var</span> prefixEnv: <span class="type">Option</span>[<span class="type">String</span>] = <span class="type">None</span></div><div class="line"></div><div class="line">    <span class="comment">// Add Xmx for AM memory</span></div><div class="line">    javaOpts += <span class="string">"-Xmx"</span> + amMemory + <span class="string">"m"</span></div><div class="line"></div><div class="line">    <span class="keyword">val</span> tmpDir = <span class="keyword">new</span> <span class="type">Path</span>(</div><div class="line">      <span class="type">YarnSparkHadoopUtil</span>.expandEnvironment(<span class="type">Environment</span>.<span class="type">PWD</span>),</div><div class="line">      <span class="type">YarnConfiguration</span>.<span class="type">DEFAULT_CONTAINER_TEMP_DIR</span></div><div class="line">    )</div><div class="line">    javaOpts += <span class="string">"-Djava.io.tmpdir="</span> + tmpDir</div><div class="line"></div><div class="line">    <span class="comment">// <span class="doctag">TODO:</span> Remove once cpuset version is pushed out.</span></div><div class="line">    <span class="comment">// The context is, default gc for server class machines ends up using all cores to do gc -</span></div><div class="line">    <span class="comment">// hence if there are multiple containers in same node, Spark GC affects all other containers'</span></div><div class="line">    <span class="comment">// performance (which can be that of other Spark containers)</span></div><div class="line">    <span class="comment">// Instead of using this, rely on cpusets by YARN to enforce "proper" Spark behavior in</span></div><div class="line">    <span class="comment">// multi-tenant environments. Not sure how default Java GC behaves if it is limited to subset</span></div><div class="line">    <span class="comment">// of cores on a node.</span></div><div class="line">    <span class="keyword">val</span> useConcurrentAndIncrementalGC = launchEnv.get(<span class="string">"SPARK_USE_CONC_INCR_GC"</span>).exists(_.toBoolean)</div><div class="line">    <span class="keyword">if</span> (useConcurrentAndIncrementalGC) &#123;</div><div class="line">      <span class="comment">// In our expts, using (default) throughput collector has severe perf ramifications in</span></div><div class="line">      <span class="comment">// multi-tenant machines</span></div><div class="line">      javaOpts += <span class="string">"-XX:+UseConcMarkSweepGC"</span></div><div class="line">      javaOpts += <span class="string">"-XX:MaxTenuringThreshold=31"</span></div><div class="line">      javaOpts += <span class="string">"-XX:SurvivorRatio=8"</span></div><div class="line">      javaOpts += <span class="string">"-XX:+CMSIncrementalMode"</span></div><div class="line">      javaOpts += <span class="string">"-XX:+CMSIncrementalPacing"</span></div><div class="line">      javaOpts += <span class="string">"-XX:CMSIncrementalDutyCycleMin=0"</span></div><div class="line">      javaOpts += <span class="string">"-XX:CMSIncrementalDutyCycle=10"</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Include driver-specific java options if we are launching a driver</span></div><div class="line">    <span class="keyword">if</span> (isClusterMode) &#123;</div><div class="line">      <span class="keyword">val</span> driverOpts = sparkConf.get(<span class="type">DRIVER_JAVA_OPTIONS</span>).orElse(sys.env.get(<span class="string">"SPARK_JAVA_OPTS"</span>))</div><div class="line">      driverOpts.foreach &#123; opts =&gt;</div><div class="line">        javaOpts ++= <span class="type">Utils</span>.splitCommandString(opts).map(<span class="type">YarnSparkHadoopUtil</span>.escapeForShell)</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">val</span> libraryPaths = <span class="type">Seq</span>(sparkConf.get(<span class="type">DRIVER_LIBRARY_PATH</span>),</div><div class="line">        sys.props.get(<span class="string">"spark.driver.libraryPath"</span>)).flatten</div><div class="line">      <span class="keyword">if</span> (libraryPaths.nonEmpty) &#123;</div><div class="line">        prefixEnv = <span class="type">Some</span>(getClusterPath(sparkConf, <span class="type">Utils</span>.libraryPathEnvPrefix(libraryPaths)))</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (sparkConf.get(<span class="type">AM_JAVA_OPTIONS</span>).isDefined) &#123;</div><div class="line">        logWarning(<span class="string">s"<span class="subst">$&#123;AM_JAVA_OPTIONS.key&#125;</span> will not take effect in cluster mode"</span>)</div><div class="line">      &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="comment">// Validate and include yarn am specific java options in yarn-client mode.</span></div><div class="line">      sparkConf.get(<span class="type">AM_JAVA_OPTIONS</span>).foreach &#123; opts =&gt;</div><div class="line">        <span class="keyword">if</span> (opts.contains(<span class="string">"-Dspark"</span>)) &#123;</div><div class="line">          <span class="keyword">val</span> msg = <span class="string">s"<span class="subst">$&#123;AM_JAVA_OPTIONS.key&#125;</span> is not allowed to set Spark options (was '<span class="subst">$opts</span>')."</span></div><div class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">SparkException</span>(msg)</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (opts.contains(<span class="string">"-Xmx"</span>)) &#123;</div><div class="line">          <span class="keyword">val</span> msg = <span class="string">s"<span class="subst">$&#123;AM_JAVA_OPTIONS.key&#125;</span> is not allowed to specify max heap memory settings "</span> +</div><div class="line">            <span class="string">s"(was '<span class="subst">$opts</span>'). Use spark.yarn.am.memory instead."</span></div><div class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">SparkException</span>(msg)</div><div class="line">        &#125;</div><div class="line">        javaOpts ++= <span class="type">Utils</span>.splitCommandString(opts).map(<span class="type">YarnSparkHadoopUtil</span>.escapeForShell)</div><div class="line">      &#125;</div><div class="line">      sparkConf.get(<span class="type">AM_LIBRARY_PATH</span>).foreach &#123; paths =&gt;</div><div class="line">        prefixEnv = <span class="type">Some</span>(getClusterPath(sparkConf, <span class="type">Utils</span>.libraryPathEnvPrefix(<span class="type">Seq</span>(paths))))</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// For log4j configuration to reference</span></div><div class="line">    javaOpts += (<span class="string">"-Dspark.yarn.app.container.log.dir="</span> + <span class="type">ApplicationConstants</span>.<span class="type">LOG_DIR_EXPANSION_VAR</span>)</div><div class="line">    <span class="type">YarnCommandBuilderUtils</span>.addPermGenSizeOpt(javaOpts)</div><div class="line"></div><div class="line">    <span class="keyword">val</span> userClass =</div><div class="line">      <span class="keyword">if</span> (isClusterMode) &#123;</div><div class="line">        <span class="type">Seq</span>(<span class="string">"--class"</span>, <span class="type">YarnSparkHadoopUtil</span>.escapeForShell(args.userClass))</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="type">Nil</span></div><div class="line">      &#125;</div><div class="line">    <span class="keyword">val</span> userJar =</div><div class="line">      <span class="keyword">if</span> (args.userJar != <span class="literal">null</span>) &#123;</div><div class="line">        <span class="type">Seq</span>(<span class="string">"--jar"</span>, args.userJar)</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="type">Nil</span></div><div class="line">      &#125;</div><div class="line">    <span class="keyword">val</span> primaryPyFile =</div><div class="line">      <span class="keyword">if</span> (isClusterMode &amp;&amp; args.primaryPyFile != <span class="literal">null</span>) &#123;</div><div class="line">        <span class="type">Seq</span>(<span class="string">"--primary-py-file"</span>, <span class="keyword">new</span> <span class="type">Path</span>(args.primaryPyFile).getName())</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="type">Nil</span></div><div class="line">      &#125;</div><div class="line">    <span class="keyword">val</span> primaryRFile =</div><div class="line">      <span class="keyword">if</span> (args.primaryRFile != <span class="literal">null</span>) &#123;</div><div class="line">        <span class="type">Seq</span>(<span class="string">"--primary-r-file"</span>, args.primaryRFile)</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="type">Nil</span></div><div class="line">      &#125;</div><div class="line">    <span class="keyword">val</span> amClass =</div><div class="line">      <span class="keyword">if</span> (isClusterMode) &#123;</div><div class="line">        <span class="type">Utils</span>.classForName(<span class="string">"org.apache.spark.deploy.yarn.ApplicationMaster"</span>).getName</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="type">Utils</span>.classForName(<span class="string">"org.apache.spark.deploy.yarn.ExecutorLauncher"</span>).getName</div><div class="line">      &#125;</div><div class="line">    <span class="keyword">if</span> (args.primaryRFile != <span class="literal">null</span> &amp;&amp; args.primaryRFile.endsWith(<span class="string">".R"</span>)) &#123;</div><div class="line">      args.userArgs = <span class="type">ArrayBuffer</span>(args.primaryRFile) ++ args.userArgs</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">val</span> userArgs = args.userArgs.flatMap &#123; arg =&gt;</div><div class="line">      <span class="type">Seq</span>(<span class="string">"--arg"</span>, <span class="type">YarnSparkHadoopUtil</span>.escapeForShell(arg))</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">val</span> amArgs =</div><div class="line">      <span class="type">Seq</span>(amClass) ++ userClass ++ userJar ++ primaryPyFile ++ primaryRFile ++</div><div class="line">        userArgs ++ <span class="type">Seq</span>(</div><div class="line">          <span class="string">"--properties-file"</span>, buildPath(<span class="type">YarnSparkHadoopUtil</span>.expandEnvironment(<span class="type">Environment</span>.<span class="type">PWD</span>),</div><div class="line">            <span class="type">LOCALIZED_CONF_DIR</span>, <span class="type">SPARK_CONF_FILE</span>))</div><div class="line"></div><div class="line">    <span class="comment">// Command for the ApplicationMaster</span></div><div class="line">    <span class="keyword">val</span> commands = prefixEnv ++ <span class="type">Seq</span>(</div><div class="line">        <span class="type">YarnSparkHadoopUtil</span>.expandEnvironment(<span class="type">Environment</span>.<span class="type">JAVA_HOME</span>) + <span class="string">"/bin/java"</span>, <span class="string">"-server"</span></div><div class="line">      ) ++</div><div class="line">      javaOpts ++ amArgs ++</div><div class="line">      <span class="type">Seq</span>(</div><div class="line">        <span class="string">"1&gt;"</span>, <span class="type">ApplicationConstants</span>.<span class="type">LOG_DIR_EXPANSION_VAR</span> + <span class="string">"/stdout"</span>,</div><div class="line">        <span class="string">"2&gt;"</span>, <span class="type">ApplicationConstants</span>.<span class="type">LOG_DIR_EXPANSION_VAR</span> + <span class="string">"/stderr"</span>)</div><div class="line"></div><div class="line">    <span class="comment">// <span class="doctag">TODO:</span> it would be nicer to just make sure there are no null commands here</span></div><div class="line">    <span class="keyword">val</span> printableCommands = commands.map(s =&gt; <span class="keyword">if</span> (s == <span class="literal">null</span>) <span class="string">"null"</span> <span class="keyword">else</span> s).toList</div><div class="line">    amContainer.setCommands(printableCommands.asJava)</div><div class="line">    ...</div><div class="line">    <span class="comment">// send the acl settings into YARN to control who has access via YARN interfaces</span></div><div class="line">    <span class="keyword">val</span> securityManager = <span class="keyword">new</span> <span class="type">SecurityManager</span>(sparkConf)</div><div class="line">    amContainer.setApplicationACLs(</div><div class="line">      <span class="type">YarnSparkHadoopUtil</span>.getApplicationAclsForYarn(securityManager).asJava)</div><div class="line">    setupSecurityToken(amContainer)</div><div class="line"></div><div class="line">    amContainer</div><div class="line">  &#125;</div><div class="line">  </div><div class="line"><span class="comment">/**</span></div><div class="line">   * Set up the context for submitting our ApplicationMaster.</div><div class="line">   * This uses the YarnClientApplication not available in the Yarn alpha API.</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">createApplicationSubmissionContext</span></span>(</div><div class="line">      newApp: <span class="type">YarnClientApplication</span>,</div><div class="line">      containerContext: <span class="type">ContainerLaunchContext</span>): <span class="type">ApplicationSubmissionContext</span> = &#123;</div><div class="line">    <span class="keyword">val</span> appContext = newApp.getApplicationSubmissionContext</div><div class="line">    appContext.setApplicationName(sparkConf.get(<span class="string">"spark.app.name"</span>, <span class="string">"Spark"</span>))</div><div class="line">    appContext.setQueue(sparkConf.get(<span class="type">QUEUE_NAME</span>))</div><div class="line">    appContext.setAMContainerSpec(containerContext)</div><div class="line">    appContext.setApplicationType(<span class="string">"SPARK"</span>)</div><div class="line"></div><div class="line">    sparkConf.get(<span class="type">APPLICATION_TAGS</span>).foreach &#123; tags =&gt;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">// The setApplicationTags method was only introduced in Hadoop 2.4+, so we need to use</span></div><div class="line">        <span class="comment">// reflection to set it, printing a warning if a tag was specified but the YARN version</span></div><div class="line">        <span class="comment">// doesn't support it.</span></div><div class="line">        <span class="keyword">val</span> method = appContext.getClass().getMethod(</div><div class="line">          <span class="string">"setApplicationTags"</span>, classOf[java.util.<span class="type">Set</span>[<span class="type">String</span>]])</div><div class="line">        method.invoke(appContext, <span class="keyword">new</span> java.util.<span class="type">HashSet</span>[<span class="type">String</span>](tags.asJava))</div><div class="line">      &#125; <span class="keyword">catch</span> &#123;</div><div class="line">        ...</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    sparkConf.get(<span class="type">MAX_APP_ATTEMPTS</span>) <span class="keyword">match</span> &#123;</div><div class="line">      <span class="keyword">case</span> <span class="type">Some</span>(v) =&gt; appContext.setMaxAppAttempts(v)</div><div class="line">      <span class="keyword">case</span> <span class="type">None</span> =&gt; logDebug(<span class="string">s"<span class="subst">$&#123;MAX_APP_ATTEMPTS.key&#125;</span> is not set. "</span> +</div><div class="line">          <span class="string">"Cluster's default value will be used."</span>)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    sparkConf.get(<span class="type">AM_ATTEMPT_FAILURE_VALIDITY_INTERVAL_MS</span>).foreach &#123; interval =&gt;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">val</span> method = appContext.getClass().getMethod(</div><div class="line">          <span class="string">"setAttemptFailuresValidityInterval"</span>, classOf[<span class="type">Long</span>])</div><div class="line">        method.invoke(appContext, interval: java.lang.<span class="type">Long</span>)</div><div class="line">      &#125; <span class="keyword">catch</span> &#123;</div><div class="line">        ...</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">val</span> capability = <span class="type">Records</span>.newRecord(classOf[<span class="type">Resource</span>])</div><div class="line">    capability.setMemory(amMemory + amMemoryOverhead)</div><div class="line">    capability.setVirtualCores(amCores)</div><div class="line"></div><div class="line">    sparkConf.get(<span class="type">AM_NODE_LABEL_EXPRESSION</span>) <span class="keyword">match</span> &#123;</div><div class="line">      <span class="keyword">case</span> <span class="type">Some</span>(expr) =&gt;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">          <span class="keyword">val</span> amRequest = <span class="type">Records</span>.newRecord(classOf[<span class="type">ResourceRequest</span>])</div><div class="line">          amRequest.setResourceName(<span class="type">ResourceRequest</span>.<span class="type">ANY</span>)</div><div class="line">          amRequest.setPriority(<span class="type">Priority</span>.newInstance(<span class="number">0</span>))</div><div class="line">          amRequest.setCapability(capability)</div><div class="line">          amRequest.setNumContainers(<span class="number">1</span>)</div><div class="line">          <span class="keyword">val</span> method = amRequest.getClass.getMethod(<span class="string">"setNodeLabelExpression"</span>, classOf[<span class="type">String</span>])</div><div class="line">          method.invoke(amRequest, expr)</div><div class="line"></div><div class="line">          <span class="keyword">val</span> setResourceRequestMethod =</div><div class="line">            appContext.getClass.getMethod(<span class="string">"setAMContainerResourceRequest"</span>, classOf[<span class="type">ResourceRequest</span>])</div><div class="line">          setResourceRequestMethod.invoke(appContext, amRequest)</div><div class="line">        &#125; <span class="keyword">catch</span> &#123;</div><div class="line">          ...</div><div class="line">        &#125;</div><div class="line">      <span class="keyword">case</span> <span class="type">None</span> =&gt;</div><div class="line">        appContext.setResource(capability)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    appContext</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<h2 id="yarn-client-api-impl-YarnClientImpl代码："><a href="#yarn-client-api-impl-YarnClientImpl代码：" class="headerlink" title="yarn.client.api.impl.YarnClientImpl代码："></a>yarn.client.api.impl.YarnClientImpl代码：</h2><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div></pre></td><td class="code"><pre><div class="line">public <span class="type">YarnClientApplication</span> createApplication() <span class="keyword">throws</span> <span class="type">YarnException</span>, <span class="type">IOException</span> &#123;</div><div class="line">        <span class="type">ApplicationSubmissionContext</span> context = (<span class="type">ApplicationSubmissionContext</span>)<span class="type">Records</span>.newRecord(<span class="type">ApplicationSubmissionContext</span>.<span class="keyword">class</span>);</div><div class="line">        <span class="type">GetNewApplicationResponse</span> newApp = <span class="keyword">this</span>.getNewApplication();</div><div class="line">        <span class="type">ApplicationId</span> appId = newApp.getApplicationId();</div><div class="line">        context.setApplicationId(appId);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="type">YarnClientApplication</span>(newApp, context);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="type">ApplicationId</span> getNewApplicationId() &#123;</div><div class="line">        <span class="type">ApplicationId</span> applicationId = <span class="type">BuilderUtils</span>.newApplicationId(<span class="keyword">this</span>.recordFactory, <span class="type">ResourceManager</span>.getClusterTimeStamp(), <span class="keyword">this</span>.applicationCounter.incrementAndGet());</div><div class="line">        <span class="type">LOG</span>.info(<span class="string">"Allocated new applicationId: "</span> + applicationId.getId());</div><div class="line">        <span class="keyword">return</span> applicationId;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">public <span class="type">ApplicationId</span> submitApplication(<span class="type">ApplicationSubmissionContext</span> appContext) <span class="keyword">throws</span> <span class="type">YarnException</span>, <span class="type">IOException</span> &#123;</div><div class="line">        <span class="type">ApplicationId</span> applicationId = appContext.getApplicationId();</div><div class="line">        <span class="keyword">if</span>(applicationId == <span class="literal">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">ApplicationIdNotProvidedException</span>(<span class="string">"ApplicationId is not provided in ApplicationSubmissionContext"</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="type">SubmitApplicationRequest</span> request = (<span class="type">SubmitApplicationRequest</span>)<span class="type">Records</span>.newRecord(<span class="type">SubmitApplicationRequest</span>.<span class="keyword">class</span>);</div><div class="line">            request.setApplicationSubmissionContext(appContext);</div><div class="line">            <span class="keyword">if</span>(<span class="keyword">this</span>.isSecurityEnabled() &amp;&amp; <span class="keyword">this</span>.timelineServiceEnabled) &#123;</div><div class="line">                <span class="keyword">this</span>.addTimelineDelegationToken(appContext.getAMContainerSpec());</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">this</span>.rmClient.submitApplication(request);</div><div class="line">            int pollCount = <span class="number">0</span>;</div><div class="line">            long startTime = <span class="type">System</span>.currentTimeMillis();</div><div class="line">            <span class="type">EnumSet</span> waitingStates = <span class="type">EnumSet</span>.of(<span class="type">YarnApplicationState</span>.<span class="type">NEW</span>, <span class="type">YarnApplicationState</span>.<span class="type">NEW_SAVING</span>, <span class="type">YarnApplicationState</span>.<span class="type">SUBMITTED</span>);</div><div class="line">            <span class="type">EnumSet</span> failToSubmitStates = <span class="type">EnumSet</span>.of(<span class="type">YarnApplicationState</span>.<span class="type">FAILED</span>, <span class="type">YarnApplicationState</span>.<span class="type">KILLED</span>);</div><div class="line"></div><div class="line">            <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</div><div class="line">                <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        <span class="type">ApplicationReport</span> ex = <span class="keyword">this</span>.getApplicationReport(applicationId);</div><div class="line">                        <span class="type">YarnApplicationState</span> state = ex.getYarnApplicationState();</div><div class="line">                        <span class="keyword">if</span>(!waitingStates.contains(state)) &#123;</div><div class="line">                            <span class="keyword">if</span>(failToSubmitStates.contains(state)) &#123;</div><div class="line">                                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">YarnException</span>(<span class="string">"Failed to submit "</span> + applicationId + <span class="string">" to YARN : "</span> + ex.getDiagnostics());</div><div class="line">                            &#125;</div><div class="line"></div><div class="line">                            <span class="type">LOG</span>.info(<span class="string">"Submitted application "</span> + applicationId);</div><div class="line">                            <span class="keyword">return</span> applicationId;</div><div class="line">                        &#125;</div><div class="line"></div><div class="line">                        long elapsedMillis = <span class="type">System</span>.currentTimeMillis() - startTime;</div><div class="line">                        <span class="keyword">if</span>(<span class="keyword">this</span>.enforceAsyncAPITimeout() &amp;&amp; elapsedMillis &gt;= <span class="keyword">this</span>.asyncApiPollTimeoutMillis) &#123;</div><div class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">YarnException</span>(<span class="string">"Timed out while waiting for application "</span> + applicationId + <span class="string">" to be submitted successfully"</span>);</div><div class="line">                        &#125;</div><div class="line"></div><div class="line">                        ++pollCount;</div><div class="line">                        <span class="keyword">if</span>(pollCount % <span class="number">10</span> == <span class="number">0</span>) &#123;</div><div class="line">                            <span class="type">LOG</span>.info(<span class="string">"Application submission is not finished, submitted application "</span> + applicationId + <span class="string">" is still in "</span> + state);</div><div class="line">                        &#125;</div><div class="line"></div><div class="line">                        <span class="keyword">try</span> &#123;</div><div class="line">                            <span class="type">Thread</span>.sleep(<span class="keyword">this</span>.submitPollIntervalMillis);</div><div class="line">                        &#125; <span class="keyword">catch</span> (<span class="type">InterruptedException</span> var14) &#123;</div><div class="line">                            <span class="type">LOG</span>.error(<span class="string">"Interrupted while waiting for application "</span> + applicationId + <span class="string">" to be successfully submitted."</span>);</div><div class="line">                        &#125;</div><div class="line">                    &#125; <span class="keyword">catch</span> (<span class="type">ApplicationNotFoundException</span> var15) &#123;</div><div class="line">                        <span class="type">LOG</span>.info(<span class="string">"Re-submit application "</span> + applicationId + <span class="string">"with the "</span> + <span class="string">"same ApplicationSubmissionContext"</span>);</div><div class="line">                        <span class="keyword">this</span>.rmClient.submitApplication(request);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">public <span class="type">SubmitApplicationResponse</span> submitApplication(<span class="type">SubmitApplicationRequest</span> request) <span class="keyword">throws</span> <span class="type">YarnException</span> &#123;</div><div class="line">        <span class="type">ApplicationSubmissionContext</span> submissionContext = request.getApplicationSubmissionContext();</div><div class="line">        <span class="type">ApplicationId</span> applicationId = submissionContext.getApplicationId();</div><div class="line">        <span class="type">String</span> user = <span class="literal">null</span>;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            user = <span class="type">UserGroupInformation</span>.getCurrentUser().getShortUserName();</div><div class="line">        &#125; <span class="keyword">catch</span> (<span class="type">IOException</span> var7) &#123;</div><div class="line">            <span class="type">LOG</span>.warn(<span class="string">"Unable to get the current user."</span>, var7);</div><div class="line">            <span class="type">RMAuditLogger</span>.logFailure(user, <span class="string">"Submit Application Request"</span>, var7.getMessage(), <span class="string">"ClientRMService"</span>, <span class="string">"Exception in submitting application"</span>, applicationId);</div><div class="line">            <span class="keyword">throw</span> <span class="type">RPCUtil</span>.getRemoteException(var7);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.rmContext.getRMApps().get(applicationId) != <span class="literal">null</span>) &#123;</div><div class="line">            <span class="type">LOG</span>.info(<span class="string">"This is an earlier submitted application: "</span> + applicationId);</div><div class="line">            <span class="keyword">return</span> <span class="type">SubmitApplicationResponse</span>.newInstance();</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span>(submissionContext.getQueue() == <span class="literal">null</span>) &#123;</div><div class="line">                submissionContext.setQueue(<span class="string">"default"</span>);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span>(submissionContext.getApplicationName() == <span class="literal">null</span>) &#123;</div><div class="line">                submissionContext.setApplicationName(<span class="string">"N/A"</span>);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span>(submissionContext.getApplicationType() == <span class="literal">null</span>) &#123;</div><div class="line">                submissionContext.setApplicationType(<span class="string">"YARN"</span>);</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(submissionContext.getApplicationType().length() &gt; <span class="number">20</span>) &#123;</div><div class="line">                submissionContext.setApplicationType(submissionContext.getApplicationType().substring(<span class="number">0</span>, <span class="number">20</span>));</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="keyword">this</span>.rmAppManager.submitApplication(submissionContext, <span class="type">System</span>.currentTimeMillis(), user);</div><div class="line">                <span class="type">LOG</span>.info(<span class="string">"Application with id "</span> + applicationId.getId() + <span class="string">" submitted by user "</span> + user);</div><div class="line">                <span class="type">RMAuditLogger</span>.logSuccess(user, <span class="string">"Submit Application Request"</span>, <span class="string">"ClientRMService"</span>, applicationId);</div><div class="line">            &#125; <span class="keyword">catch</span> (<span class="type">YarnException</span> var6) &#123;</div><div class="line">                <span class="type">LOG</span>.info(<span class="string">"Exception in submitting application with id "</span> + applicationId.getId(), var6);</div><div class="line">                <span class="type">RMAuditLogger</span>.logFailure(user, <span class="string">"Submit Application Request"</span>, var6.getMessage(), <span class="string">"ClientRMService"</span>, <span class="string">"Exception in submitting application"</span>, applicationId);</div><div class="line">                <span class="keyword">throw</span> var6;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="type">SubmitApplicationResponse</span> response = (<span class="type">SubmitApplicationResponse</span>)<span class="keyword">this</span>.recordFactory.newRecordInstance(<span class="type">SubmitApplicationResponse</span>.<span class="keyword">class</span>);</div><div class="line">            <span class="keyword">return</span> response;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> void submitApplication(<span class="type">ApplicationSubmissionContext</span> submissionContext, long submitTime, <span class="type">String</span> user) <span class="keyword">throws</span> <span class="type">YarnException</span> &#123;</div><div class="line">        <span class="type">ApplicationId</span> applicationId = submissionContext.getApplicationId();</div><div class="line">        <span class="type">RMAppImpl</span> application = <span class="keyword">this</span>.createAndPopulateNewRMApp(submissionContext, submitTime, user, <span class="literal">false</span>);</div><div class="line">        <span class="type">ApplicationId</span> appId = submissionContext.getApplicationId();</div><div class="line">        <span class="keyword">if</span>(<span class="type">UserGroupInformation</span>.isSecurityEnabled()) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="keyword">this</span>.rmContext.getDelegationTokenRenewer().addApplicationAsync(appId, <span class="keyword">this</span>.parseCredentials(submissionContext), submissionContext.getCancelTokensWhenComplete(), application.getUser());</div><div class="line">            &#125; <span class="keyword">catch</span> (<span class="type">Exception</span> var9) &#123;</div><div class="line">                <span class="type">LOG</span>.warn(<span class="string">"Unable to parse credentials."</span>, var9);</div><div class="line"></div><div class="line">                assert application.getState() == <span class="type">RMAppState</span>.<span class="type">NEW</span>;</div><div class="line"></div><div class="line">                <span class="keyword">this</span>.rmContext.getDispatcher().getEventHandler().handle(<span class="keyword">new</span> <span class="type">RMAppEvent</span>(applicationId, <span class="type">RMAppEventType</span>.<span class="type">APP_REJECTED</span>, var9.getMessage()));</div><div class="line">                <span class="keyword">throw</span> <span class="type">RPCUtil</span>.getRemoteException(var9);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">this</span>.rmContext.getDispatcher().getEventHandler().handle(<span class="keyword">new</span> <span class="type">RMAppEvent</span>(applicationId, <span class="type">RMAppEventType</span>.<span class="type">START</span>));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h2 id="deploy-yarn-ApplicationMaster代码："><a href="#deploy-yarn-ApplicationMaster代码：" class="headerlink" title="deploy.yarn.ApplicationMaster代码："></a>deploy.yarn.ApplicationMaster代码：</h2><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</div><div class="line">    <span class="type">SignalUtils</span>.registerLogger(log)</div><div class="line">    <span class="keyword">val</span> amArgs = <span class="keyword">new</span> <span class="type">ApplicationMasterArguments</span>(args)</div><div class="line"></div><div class="line">    <span class="comment">// Load the properties file with the Spark configuration and set entries as system properties,</span></div><div class="line">    <span class="comment">// so that user code run inside the AM also has access to them.</span></div><div class="line">    <span class="comment">// Note: we must do this before SparkHadoopUtil instantiated</span></div><div class="line">    <span class="keyword">if</span> (amArgs.propertiesFile != <span class="literal">null</span>) &#123;</div><div class="line">      <span class="type">Utils</span>.getPropertiesFromFile(amArgs.propertiesFile).foreach &#123; <span class="keyword">case</span> (k, v) =&gt;</div><div class="line">        sys.props(k) = v</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="type">SparkHadoopUtil</span>.get.runAsSparkUser &#123; () =&gt;</div><div class="line">      master = <span class="keyword">new</span> <span class="type">ApplicationMaster</span>(amArgs, <span class="keyword">new</span> <span class="type">YarnRMClient</span>)</div><div class="line">      <span class="type">System</span>.exit(master.run())</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">final</span> <span class="function"><span class="keyword">def</span> <span class="title">run</span></span>(): <span class="type">Int</span> = &#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      <span class="keyword">val</span> appAttemptId = client.getAttemptId()</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (isClusterMode) &#123;</div><div class="line">        <span class="comment">// Set the web ui port to be ephemeral for yarn so we don't conflict with</span></div><div class="line">        <span class="comment">// other spark processes running on the same box</span></div><div class="line">        <span class="type">System</span>.setProperty(<span class="string">"spark.ui.port"</span>, <span class="string">"0"</span>)</div><div class="line"></div><div class="line">        <span class="comment">// Set the master and deploy mode property to match the requested mode.</span></div><div class="line">        <span class="type">System</span>.setProperty(<span class="string">"spark.master"</span>, <span class="string">"yarn"</span>)</div><div class="line">        <span class="type">System</span>.setProperty(<span class="string">"spark.submit.deployMode"</span>, <span class="string">"cluster"</span>)</div><div class="line"></div><div class="line">        <span class="comment">// Set this internal configuration if it is running on cluster mode, this</span></div><div class="line">        <span class="comment">// configuration will be checked in SparkContext to avoid misuse of yarn cluster mode.</span></div><div class="line">        <span class="type">System</span>.setProperty(<span class="string">"spark.yarn.app.id"</span>, appAttemptId.getApplicationId().toString())</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      logInfo(<span class="string">"ApplicationAttemptId: "</span> + appAttemptId)</div><div class="line"></div><div class="line">      <span class="keyword">val</span> fs = <span class="type">FileSystem</span>.get(yarnConf)</div><div class="line"></div><div class="line">      <span class="comment">// This shutdown hook should run *after* the SparkContext is shut down.</span></div><div class="line">      <span class="keyword">val</span> priority = <span class="type">ShutdownHookManager</span>.<span class="type">SPARK_CONTEXT_SHUTDOWN_PRIORITY</span> - <span class="number">1</span></div><div class="line">      <span class="type">ShutdownHookManager</span>.addShutdownHook(priority) &#123; () =&gt;</div><div class="line">        <span class="keyword">val</span> maxAppAttempts = client.getMaxRegAttempts(sparkConf, yarnConf)</div><div class="line">        <span class="keyword">val</span> isLastAttempt = client.getAttemptId().getAttemptId() &gt;= maxAppAttempts</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (!finished) &#123;</div><div class="line">          <span class="comment">// The default state of ApplicationMaster is failed if it is invoked by shut down hook.</span></div><div class="line">          <span class="comment">// This behavior is different compared to 1.x version.</span></div><div class="line">          <span class="comment">// If user application is exited ahead of time by calling System.exit(N), here mark</span></div><div class="line">          <span class="comment">// this application as failed with EXIT_EARLY. For a good shutdown, user shouldn't call</span></div><div class="line">          <span class="comment">// System.exit(0) to terminate the application.</span></div><div class="line">          finish(finalStatus,</div><div class="line">            <span class="type">ApplicationMaster</span>.<span class="type">EXIT_EARLY</span>,</div><div class="line">            <span class="string">"Shutdown hook called before final status was reported."</span>)</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (!unregistered) &#123;</div><div class="line">          <span class="comment">// we only want to unregister if we don't want the RM to retry</span></div><div class="line">          <span class="keyword">if</span> (finalStatus == <span class="type">FinalApplicationStatus</span>.<span class="type">SUCCEEDED</span> || isLastAttempt) &#123;</div><div class="line">            unregister(finalStatus, finalMsg)</div><div class="line">            cleanupStagingDir(fs)</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">// Call this to force generation of secret so it gets populated into the</span></div><div class="line">      <span class="comment">// Hadoop UGI. This has to happen before the startUserApplication which does a</span></div><div class="line">      <span class="comment">// doAs in order for the credentials to be passed on to the executor containers.</span></div><div class="line">      <span class="keyword">val</span> securityMgr = <span class="keyword">new</span> <span class="type">SecurityManager</span>(sparkConf)</div><div class="line"></div><div class="line">      <span class="comment">// If the credentials file config is present, we must periodically renew tokens. So create</span></div><div class="line">      <span class="comment">// a new AMDelegationTokenRenewer</span></div><div class="line">      <span class="keyword">if</span> (sparkConf.contains(<span class="type">CREDENTIALS_FILE_PATH</span>.key)) &#123;</div><div class="line">        delegationTokenRenewerOption = <span class="type">Some</span>(<span class="keyword">new</span> <span class="type">AMDelegationTokenRenewer</span>(sparkConf, yarnConf))</div><div class="line">        <span class="comment">// If a principal and keytab have been set, use that to create new credentials for executors</span></div><div class="line">        <span class="comment">// periodically</span></div><div class="line">        delegationTokenRenewerOption.foreach(_.scheduleLoginFromKeytab())</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (isClusterMode) &#123;</div><div class="line">        runDriver(securityMgr)</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        runExecutorLauncher(securityMgr)</div><div class="line">      &#125;</div><div class="line">    &#125; <span class="keyword">catch</span> &#123;</div><div class="line">      <span class="keyword">case</span> e: <span class="type">Exception</span> =&gt;</div><div class="line">        <span class="comment">// catch everything else if not specifically handled</span></div><div class="line">        logError(<span class="string">"Uncaught exception: "</span>, e)</div><div class="line">        finish(<span class="type">FinalApplicationStatus</span>.<span class="type">FAILED</span>,</div><div class="line">          <span class="type">ApplicationMaster</span>.<span class="type">EXIT_UNCAUGHT_EXCEPTION</span>,</div><div class="line">          <span class="string">"Uncaught exception: "</span> + e)</div><div class="line">    &#125;</div><div class="line">    exitCode</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  </div><div class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">runDriver</span></span>(securityMgr: <span class="type">SecurityManager</span>): <span class="type">Unit</span> = &#123;</div><div class="line">    addAmIpFilter()</div><div class="line">    userClassThread = startUserApplication()</div><div class="line"></div><div class="line">    <span class="comment">// This a bit hacky, but we need to wait until the spark.driver.port property has</span></div><div class="line">    <span class="comment">// been set by the Thread executing the user class.</span></div><div class="line">    <span class="keyword">val</span> sc = waitForSparkContextInitialized()</div><div class="line"></div><div class="line">    <span class="comment">// If there is no SparkContext at this point, just fail the app.</span></div><div class="line">    <span class="keyword">if</span> (sc == <span class="literal">null</span>) &#123;</div><div class="line">      finish(<span class="type">FinalApplicationStatus</span>.<span class="type">FAILED</span>,</div><div class="line">        <span class="type">ApplicationMaster</span>.<span class="type">EXIT_SC_NOT_INITED</span>,</div><div class="line">        <span class="string">"Timed out waiting for SparkContext."</span>)</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      rpcEnv = sc.env.rpcEnv</div><div class="line">      <span class="keyword">val</span> driverRef = runAMEndpoint(</div><div class="line">        sc.getConf.get(<span class="string">"spark.driver.host"</span>),</div><div class="line">        sc.getConf.get(<span class="string">"spark.driver.port"</span>),</div><div class="line">        isClusterMode = <span class="literal">true</span>)</div><div class="line">      registerAM(rpcEnv, driverRef, sc.ui.map(_.appUIAddress).getOrElse(<span class="string">""</span>), securityMgr)</div><div class="line">      userClassThread.join()</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">   * Start the user class, which contains the spark driver, in a separate Thread.</div><div class="line">   * If the main routine exits cleanly or exits with System.exit(N) for any N</div><div class="line">   * we assume it was successful, for all other cases we assume failure.</div><div class="line">   *</div><div class="line">   * Returns the user thread that was started.</div><div class="line">   */</div><div class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">startUserApplication</span></span>(): <span class="type">Thread</span> = &#123;</div><div class="line">    logInfo(<span class="string">"Starting the user application in a separate Thread"</span>)</div><div class="line"></div><div class="line">    <span class="keyword">val</span> classpath = <span class="type">Client</span>.getUserClasspath(sparkConf)</div><div class="line">    <span class="keyword">val</span> urls = classpath.map &#123; entry =&gt;</div><div class="line">      <span class="keyword">new</span> <span class="type">URL</span>(<span class="string">"file:"</span> + <span class="keyword">new</span> <span class="type">File</span>(entry.getPath()).getAbsolutePath())</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">val</span> userClassLoader =</div><div class="line">      <span class="keyword">if</span> (<span class="type">Client</span>.isUserClassPathFirst(sparkConf, isDriver = <span class="literal">true</span>)) &#123;</div><div class="line">        <span class="keyword">new</span> <span class="type">ChildFirstURLClassLoader</span>(urls, <span class="type">Utils</span>.getContextOrSparkClassLoader)</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">new</span> <span class="type">MutableURLClassLoader</span>(urls, <span class="type">Utils</span>.getContextOrSparkClassLoader)</div><div class="line">      &#125;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> userArgs = args.userArgs</div><div class="line">    <span class="keyword">if</span> (args.primaryPyFile != <span class="literal">null</span> &amp;&amp; args.primaryPyFile.endsWith(<span class="string">".py"</span>)) &#123;</div><div class="line">      <span class="comment">// When running pyspark, the app is run using PythonRunner. The second argument is the list</span></div><div class="line">      <span class="comment">// of files to add to PYTHONPATH, which Client.scala already handles, so it's empty.</span></div><div class="line">      userArgs = <span class="type">Seq</span>(args.primaryPyFile, <span class="string">""</span>) ++ userArgs</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (args.primaryRFile != <span class="literal">null</span> &amp;&amp; args.primaryRFile.endsWith(<span class="string">".R"</span>)) &#123;</div><div class="line">      <span class="comment">// TODO(davies): add R dependencies here</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">val</span> mainMethod = userClassLoader.loadClass(args.userClass)</div><div class="line">      .getMethod(<span class="string">"main"</span>, classOf[<span class="type">Array</span>[<span class="type">String</span>]])</div><div class="line"></div><div class="line">    <span class="keyword">val</span> userThread = <span class="keyword">new</span> <span class="type">Thread</span> &#123;</div><div class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">run</span></span>() &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">          mainMethod.invoke(<span class="literal">null</span>, userArgs.toArray)</div><div class="line">          finish(<span class="type">FinalApplicationStatus</span>.<span class="type">SUCCEEDED</span>, <span class="type">ApplicationMaster</span>.<span class="type">EXIT_SUCCESS</span>)</div><div class="line">          logDebug(<span class="string">"Done running users class"</span>)</div><div class="line">        &#125; <span class="keyword">catch</span> &#123;</div><div class="line">          ...</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    userThread.setContextClassLoader(userClassLoader)</div><div class="line">    userThread.setName(<span class="string">"Driver"</span>)</div><div class="line">    userThread.start()</div><div class="line">    userThread</div><div class="line">  &#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">   * Create an [[RpcEndpoint]] that communicates with the driver.</div><div class="line">   *</div><div class="line">   * In cluster mode, the AM and the driver belong to same process</div><div class="line">   * so the AMEndpoint need not monitor lifecycle of the driver.</div><div class="line">   *</div><div class="line">   * @return A reference to the driver's RPC endpoint.</div><div class="line">   */</div><div class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">runAMEndpoint</span></span>(</div><div class="line">      host: <span class="type">String</span>,</div><div class="line">      port: <span class="type">String</span>,</div><div class="line">      isClusterMode: <span class="type">Boolean</span>): <span class="type">RpcEndpointRef</span> = &#123;</div><div class="line">    <span class="keyword">val</span> driverEndpoint = rpcEnv.setupEndpointRef(</div><div class="line">      <span class="type">RpcAddress</span>(host, port.toInt),</div><div class="line">      <span class="type">YarnSchedulerBackend</span>.<span class="type">ENDPOINT_NAME</span>)</div><div class="line">    amEndpoint =</div><div class="line">      rpcEnv.setupEndpoint(<span class="string">"YarnAM"</span>, <span class="keyword">new</span> <span class="type">AMEndpoint</span>(rpcEnv, driverEndpoint, isClusterMode))</div><div class="line">    driverEndpoint</div><div class="line">  &#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">registerAM</span></span>(</div><div class="line">      _rpcEnv: <span class="type">RpcEnv</span>,</div><div class="line">      driverRef: <span class="type">RpcEndpointRef</span>,</div><div class="line">      uiAddress: <span class="type">String</span>,</div><div class="line">      securityMgr: <span class="type">SecurityManager</span>) = &#123;</div><div class="line">    <span class="keyword">val</span> sc = sparkContextRef.get()</div><div class="line"></div><div class="line">    <span class="keyword">val</span> appId = client.getAttemptId().getApplicationId().toString()</div><div class="line">    <span class="keyword">val</span> attemptId = client.getAttemptId().getAttemptId().toString()</div><div class="line">    <span class="keyword">val</span> historyAddress =</div><div class="line">      sparkConf.get(<span class="type">HISTORY_SERVER_ADDRESS</span>)</div><div class="line">        .map &#123; text =&gt; <span class="type">SparkHadoopUtil</span>.get.substituteHadoopVariables(text, yarnConf) &#125;</div><div class="line">        .map &#123; address =&gt; <span class="string">s"<span class="subst">$&#123;address&#125;</span><span class="subst">$&#123;HistoryServer.UI_PATH_PREFIX&#125;</span>/<span class="subst">$&#123;appId&#125;</span>/<span class="subst">$&#123;attemptId&#125;</span>"</span> &#125;</div><div class="line">        .getOrElse(<span class="string">""</span>)</div><div class="line"></div><div class="line">    <span class="keyword">val</span> _sparkConf = <span class="keyword">if</span> (sc != <span class="literal">null</span>) sc.getConf <span class="keyword">else</span> sparkConf</div><div class="line">    <span class="keyword">val</span> driverUrl = <span class="type">RpcEndpointAddress</span>(</div><div class="line">      _sparkConf.get(<span class="string">"spark.driver.host"</span>),</div><div class="line">      _sparkConf.get(<span class="string">"spark.driver.port"</span>).toInt,</div><div class="line">      <span class="type">CoarseGrainedSchedulerBackend</span>.<span class="type">ENDPOINT_NAME</span>).toString</div><div class="line">    allocator = client.register(driverUrl,</div><div class="line">      driverRef,</div><div class="line">      yarnConf,</div><div class="line">      _sparkConf,</div><div class="line">      uiAddress,</div><div class="line">      historyAddress,</div><div class="line">      securityMgr,</div><div class="line">      localResources)</div><div class="line"></div><div class="line">    allocator.allocateResources()</div><div class="line">    reporterThread = launchReporterThread()</div><div class="line">  &#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">runExecutorLauncher</span></span>(securityMgr: <span class="type">SecurityManager</span>): <span class="type">Unit</span> = &#123;</div><div class="line">    <span class="keyword">val</span> port = sparkConf.getInt(<span class="string">"spark.yarn.am.port"</span>, <span class="number">0</span>)</div><div class="line">    rpcEnv = <span class="type">RpcEnv</span>.create(<span class="string">"sparkYarnAM"</span>, <span class="type">Utils</span>.localHostName, port, sparkConf, securityMgr,</div><div class="line">      clientMode = <span class="literal">true</span>)</div><div class="line">    <span class="keyword">val</span> driverRef = waitForSparkDriver()</div><div class="line">    addAmIpFilter()</div><div class="line">    registerAM(rpcEnv, driverRef, sparkConf.get(<span class="string">"spark.driver.appUIAddress"</span>, <span class="string">""</span>), securityMgr)</div><div class="line"></div><div class="line">    <span class="comment">// In client mode the actor will stop the reporter thread.</span></div><div class="line">    reporterThread.join()</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<h2 id="YarnRMClient"><a href="#YarnRMClient" class="headerlink" title="YarnRMClient"></a>YarnRMClient</h2><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">   * Registers the application master with the RM.</div><div class="line">   *</div><div class="line">   * @param conf The Yarn configuration.</div><div class="line">   * @param sparkConf The Spark configuration.</div><div class="line">   * @param uiAddress Address of the SparkUI.</div><div class="line">   * @param uiHistoryAddress Address of the application on the History Server.</div><div class="line">   * @param securityMgr The security manager.</div><div class="line">   * @param localResources Map with information about files distributed via YARN's cache.</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">register</span></span>(</div><div class="line">      driverUrl: <span class="type">String</span>,</div><div class="line">      driverRef: <span class="type">RpcEndpointRef</span>,</div><div class="line">      conf: <span class="type">YarnConfiguration</span>,</div><div class="line">      sparkConf: <span class="type">SparkConf</span>,</div><div class="line">      uiAddress: <span class="type">String</span>,</div><div class="line">      uiHistoryAddress: <span class="type">String</span>,</div><div class="line">      securityMgr: <span class="type">SecurityManager</span>,</div><div class="line">      localResources: <span class="type">Map</span>[<span class="type">String</span>, <span class="type">LocalResource</span>]</div><div class="line">    ): <span class="type">YarnAllocator</span> = &#123;</div><div class="line">    amClient = <span class="type">AMRMClient</span>.createAMRMClient()</div><div class="line">    amClient.init(conf)</div><div class="line">    amClient.start()</div><div class="line">    <span class="keyword">this</span>.uiHistoryAddress = uiHistoryAddress</div><div class="line"></div><div class="line">    logInfo(<span class="string">"Registering the ApplicationMaster"</span>)</div><div class="line">    synchronized &#123;</div><div class="line">      amClient.registerApplicationMaster(<span class="type">Utils</span>.localHostName(), <span class="number">0</span>, uiAddress)</div><div class="line">      registered = <span class="literal">true</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">new</span> <span class="type">YarnAllocator</span>(driverUrl, driverRef, conf, sparkConf, amClient, getAttemptId(), securityMgr,</div><div class="line">      localResources)</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<h2 id="YarnAllocator"><a href="#YarnAllocator" class="headerlink" title="YarnAllocator"></a>YarnAllocator</h2><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * YarnAllocator is charged with requesting containers from the YARN ResourceManager and deciding</div><div class="line"> * what to do with containers when YARN fulfills these requests.</div><div class="line"> *</div><div class="line"> * This class makes use of YARN's AMRMClient APIs. We interact with the AMRMClient in three ways:</div><div class="line"> * * Making our resource needs known, which updates local bookkeeping about containers requested.</div><div class="line"> * * Calling "allocate", which syncs our local container requests with the RM, and returns any</div><div class="line"> *   containers that YARN has granted to us.  This also functions as a heartbeat.</div><div class="line"> * * Processing the containers granted to us to possibly launch executors inside of them.</div><div class="line"> *</div><div class="line"> * The public methods of this class are thread-safe.  All methods that mutate state are</div><div class="line"> * synchronized.</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">   * Request resources such that, if YARN gives us all we ask for, we'll have a number of containers</div><div class="line">   * equal to maxExecutors.</div><div class="line">   *</div><div class="line">   * Deal with any containers YARN has granted to us by possibly launching executors in them.</div><div class="line">   *</div><div class="line">   * This must be synchronized because variables read in this method are mutated by other methods.</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">allocateResources</span></span>(): <span class="type">Unit</span> = synchronized &#123;</div><div class="line">    updateResourceRequests()</div><div class="line"></div><div class="line">    <span class="keyword">val</span> progressIndicator = <span class="number">0.1</span>f</div><div class="line">    <span class="comment">// Poll the ResourceManager. This doubles as a heartbeat if there are no pending container</span></div><div class="line">    <span class="comment">// requests.</span></div><div class="line">    <span class="keyword">val</span> allocateResponse = amClient.allocate(progressIndicator)</div><div class="line"></div><div class="line">    <span class="keyword">val</span> allocatedContainers = allocateResponse.getAllocatedContainers()</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (allocatedContainers.size &gt; <span class="number">0</span>) &#123;</div><div class="line">      logDebug(<span class="string">"Allocated containers: %d. Current executor count: %d. Cluster resources: %s."</span></div><div class="line">        .format(</div><div class="line">          allocatedContainers.size,</div><div class="line">          numExecutorsRunning,</div><div class="line">          allocateResponse.getAvailableResources))</div><div class="line"></div><div class="line">      handleAllocatedContainers(allocatedContainers.asScala)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">val</span> completedContainers = allocateResponse.getCompletedContainersStatuses()</div><div class="line">    <span class="keyword">if</span> (completedContainers.size &gt; <span class="number">0</span>) &#123;</div><div class="line">      logDebug(<span class="string">"Completed %d containers"</span>.format(completedContainers.size))</div><div class="line">      processCompletedContainers(completedContainers.asScala)</div><div class="line">      logDebug(<span class="string">"Finished processing %d completed containers. Current running executor count: %d."</span></div><div class="line">        .format(completedContainers.size, numExecutorsRunning))</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">   * Handle containers granted by the RM by launching executors on them.</div><div class="line">   *</div><div class="line">   * Due to the way the YARN allocation protocol works, certain healthy race conditions can result</div><div class="line">   * in YARN granting containers that we no longer need. In this case, we release them.</div><div class="line">   *</div><div class="line">   * Visible for testing.</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">handleAllocatedContainers</span></span>(allocatedContainers: <span class="type">Seq</span>[<span class="type">Container</span>]): <span class="type">Unit</span> = &#123;</div><div class="line">    <span class="keyword">val</span> containersToUse = <span class="keyword">new</span> <span class="type">ArrayBuffer</span>[<span class="type">Container</span>](allocatedContainers.size)</div><div class="line"></div><div class="line">    <span class="comment">// Match incoming requests by host</span></div><div class="line">    <span class="keyword">val</span> remainingAfterHostMatches = <span class="keyword">new</span> <span class="type">ArrayBuffer</span>[<span class="type">Container</span>]</div><div class="line">    <span class="keyword">for</span> (allocatedContainer &lt;- allocatedContainers) &#123;</div><div class="line">      matchContainerToRequest(allocatedContainer, allocatedContainer.getNodeId.getHost,</div><div class="line">        containersToUse, remainingAfterHostMatches)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Match remaining by rack</span></div><div class="line">    <span class="keyword">val</span> remainingAfterRackMatches = <span class="keyword">new</span> <span class="type">ArrayBuffer</span>[<span class="type">Container</span>]</div><div class="line">    <span class="keyword">for</span> (allocatedContainer &lt;- remainingAfterHostMatches) &#123;</div><div class="line">      <span class="keyword">val</span> rack = <span class="type">RackResolver</span>.resolve(conf, allocatedContainer.getNodeId.getHost).getNetworkLocation</div><div class="line">      matchContainerToRequest(allocatedContainer, rack, containersToUse,</div><div class="line">        remainingAfterRackMatches)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Assign remaining that are neither node-local nor rack-local</span></div><div class="line">    <span class="keyword">val</span> remainingAfterOffRackMatches = <span class="keyword">new</span> <span class="type">ArrayBuffer</span>[<span class="type">Container</span>]</div><div class="line">    <span class="keyword">for</span> (allocatedContainer &lt;- remainingAfterRackMatches) &#123;</div><div class="line">      matchContainerToRequest(allocatedContainer, <span class="type">ANY_HOST</span>, containersToUse,</div><div class="line">        remainingAfterOffRackMatches)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!remainingAfterOffRackMatches.isEmpty) &#123;</div><div class="line">      logDebug(<span class="string">s"Releasing <span class="subst">$&#123;remainingAfterOffRackMatches.size&#125;</span> unneeded containers that were "</span> +</div><div class="line">        <span class="string">s"allocated to us"</span>)</div><div class="line">      <span class="keyword">for</span> (container &lt;- remainingAfterOffRackMatches) &#123;</div><div class="line">        internalReleaseContainer(container)</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    runAllocatedContainers(containersToUse)</div><div class="line"></div><div class="line">    logInfo(<span class="string">"Received %d containers from YARN, launching executors on %d of them."</span></div><div class="line">      .format(allocatedContainers.size, containersToUse.size))</div><div class="line">  &#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line">  public <span class="type">AllocateResponse</span> allocate(float progressIndicator) </div><div class="line">      <span class="keyword">throws</span> <span class="type">YarnException</span>, <span class="type">IOException</span> &#123;</div><div class="line">    <span class="type">Preconditions</span>.checkArgument(progressIndicator &gt;= <span class="number">0</span>,</div><div class="line">        <span class="string">"Progress indicator should not be negative"</span>);</div><div class="line">    <span class="type">AllocateResponse</span> allocateResponse = <span class="literal">null</span>;</div><div class="line">    <span class="type">List</span>&lt;<span class="type">ResourceRequest</span>&gt; askList = <span class="literal">null</span>;</div><div class="line">    <span class="type">List</span>&lt;<span class="type">ContainerId</span>&gt; releaseList = <span class="literal">null</span>;</div><div class="line">    <span class="type">AllocateRequest</span> allocateRequest = <span class="literal">null</span>;</div><div class="line">    <span class="type">List</span>&lt;<span class="type">String</span>&gt; blacklistToAdd = <span class="keyword">new</span> <span class="type">ArrayList</span>&lt;<span class="type">String</span>&gt;();</div><div class="line">    <span class="type">List</span>&lt;<span class="type">String</span>&gt; blacklistToRemove = <span class="keyword">new</span> <span class="type">ArrayList</span>&lt;<span class="type">String</span>&gt;();</div><div class="line">    </div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      synchronized (<span class="keyword">this</span>) &#123;</div><div class="line">        askList = <span class="keyword">new</span> <span class="type">ArrayList</span>&lt;<span class="type">ResourceRequest</span>&gt;(ask.size());</div><div class="line">        <span class="keyword">for</span>(<span class="type">ResourceRequest</span> r : ask) &#123;</div><div class="line">          <span class="comment">// create a copy of ResourceRequest as we might change it while the </span></div><div class="line">          <span class="comment">// RPC layer is using it to send info across</span></div><div class="line">          askList.add(<span class="type">ResourceRequest</span>.newInstance(r.getPriority(),</div><div class="line">              r.getResourceName(), r.getCapability(), r.getNumContainers(),</div><div class="line">              r.getRelaxLocality(), r.getNodeLabelExpression()));</div><div class="line">        &#125;</div><div class="line">        releaseList = <span class="keyword">new</span> <span class="type">ArrayList</span>&lt;<span class="type">ContainerId</span>&gt;(release);</div><div class="line">        <span class="comment">// optimistically clear this collection assuming no RPC failure</span></div><div class="line">        ask.clear();</div><div class="line">        release.clear();</div><div class="line"></div><div class="line">        blacklistToAdd.addAll(blacklistAdditions);</div><div class="line">        blacklistToRemove.addAll(blacklistRemovals);</div><div class="line">        </div><div class="line">        <span class="type">ResourceBlacklistRequest</span> blacklistRequest =</div><div class="line">            <span class="type">ResourceBlacklistRequest</span>.newInstance(blacklistToAdd,</div><div class="line">                blacklistToRemove);</div><div class="line">        </div><div class="line">        allocateRequest =</div><div class="line">            <span class="type">AllocateRequest</span>.newInstance(lastResponseId, progressIndicator,</div><div class="line">              askList, releaseList, blacklistRequest);</div><div class="line">        <span class="comment">// clear blacklistAdditions and blacklistRemovals before </span></div><div class="line">        <span class="comment">// unsynchronized part</span></div><div class="line">        blacklistAdditions.clear();</div><div class="line">        blacklistRemovals.clear();</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        allocateResponse = rmClient.allocate(allocateRequest);</div><div class="line">      &#125; <span class="keyword">catch</span> (<span class="type">ApplicationMasterNotRegisteredException</span> e) &#123;</div><div class="line">        <span class="type">LOG</span>.warn(<span class="string">"ApplicationMaster is out of sync with ResourceManager,"</span></div><div class="line">            + <span class="string">" hence resyncing."</span>);</div><div class="line">        synchronized (<span class="keyword">this</span>) &#123;</div><div class="line">          release.addAll(<span class="keyword">this</span>.pendingRelease);</div><div class="line">          blacklistAdditions.addAll(<span class="keyword">this</span>.blacklistedNodes);</div><div class="line">          <span class="keyword">for</span> (<span class="type">Map</span>&lt;<span class="type">String</span>, <span class="type">TreeMap</span>&lt;<span class="type">Resource</span>, <span class="type">ResourceRequestInfo</span>&gt;&gt; rr : remoteRequestsTable</div><div class="line">            .values()) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="type">Map</span>&lt;<span class="type">Resource</span>, <span class="type">ResourceRequestInfo</span>&gt; capabalities : rr.values()) &#123;</div><div class="line">              <span class="keyword">for</span> (<span class="type">ResourceRequestInfo</span> request : capabalities.values()) &#123;</div><div class="line">                addResourceRequestToAsk(request.remoteRequest);</div><div class="line">              &#125;</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// re register with RM</span></div><div class="line">        registerApplicationMaster();</div><div class="line">        allocateResponse = allocate(progressIndicator);</div><div class="line">        <span class="keyword">return</span> allocateResponse;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      synchronized (<span class="keyword">this</span>) &#123;</div><div class="line">        <span class="comment">// update these on successful RPC</span></div><div class="line">        clusterNodeCount = allocateResponse.getNumClusterNodes();</div><div class="line">        lastResponseId = allocateResponse.getResponseId();</div><div class="line">        clusterAvailableResources = allocateResponse.getAvailableResources();</div><div class="line">        <span class="keyword">if</span> (!allocateResponse.getNMTokens().isEmpty()) &#123;</div><div class="line">          populateNMTokens(allocateResponse.getNMTokens());</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (allocateResponse.getAMRMToken() != <span class="literal">null</span>) &#123;</div><div class="line">          updateAMRMToken(allocateResponse.getAMRMToken());</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (!pendingRelease.isEmpty()</div><div class="line">            &amp;&amp; !allocateResponse.getCompletedContainersStatuses().isEmpty()) &#123;</div><div class="line">          removePendingReleaseRequests(allocateResponse</div><div class="line">              .getCompletedContainersStatuses());</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">      <span class="comment">// TODO how to differentiate remote yarn exception vs error in rpc</span></div><div class="line">      <span class="keyword">if</span>(allocateResponse == <span class="literal">null</span>) &#123;</div><div class="line">        <span class="comment">// we hit an exception in allocate()</span></div><div class="line">        <span class="comment">// preserve ask and release for next call to allocate()</span></div><div class="line">        synchronized (<span class="keyword">this</span>) &#123;</div><div class="line">          release.addAll(releaseList);</div><div class="line">          <span class="comment">// requests could have been added or deleted during call to allocate</span></div><div class="line">          <span class="comment">// If requests were added/removed then there is nothing to do since</span></div><div class="line">          <span class="comment">// the ResourceRequest object in ask would have the actual new value.</span></div><div class="line">          <span class="comment">// If ask does not have this ResourceRequest then it was unchanged and</span></div><div class="line">          <span class="comment">// so we can add the value back safely.</span></div><div class="line">          <span class="comment">// This assumes that there will no concurrent calls to allocate() and</span></div><div class="line">          <span class="comment">// so we dont have to worry about ask being changed in the</span></div><div class="line">          <span class="comment">// synchronized block at the beginning of this method.</span></div><div class="line">          <span class="keyword">for</span>(<span class="type">ResourceRequest</span> oldAsk : askList) &#123;</div><div class="line">            <span class="keyword">if</span>(!ask.contains(oldAsk)) &#123;</div><div class="line">              ask.add(oldAsk);</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">          </div><div class="line">          blacklistAdditions.addAll(blacklistToAdd);</div><div class="line">          blacklistRemovals.addAll(blacklistToRemove);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> allocateResponse;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">public <span class="type">AllocateResponse</span> allocate(<span class="type">AllocateRequest</span> request) <span class="keyword">throws</span> <span class="type">YarnException</span>, <span class="type">IOException</span> &#123;</div><div class="line">        <span class="type">AMRMTokenIdentifier</span> amrmTokenIdentifier = <span class="keyword">this</span>.authorizeRequest();</div><div class="line">        <span class="type">ApplicationAttemptId</span> appAttemptId = amrmTokenIdentifier.getApplicationAttemptId();</div><div class="line">        <span class="type">ApplicationId</span> applicationId = appAttemptId.getApplicationId();</div><div class="line">        <span class="keyword">this</span>.amLivelinessMonitor.receivedPing(appAttemptId);</div><div class="line">        <span class="type">ApplicationMasterService</span>.<span class="type">AllocateResponseLock</span> lock = (<span class="type">ApplicationMasterService</span>.<span class="type">AllocateResponseLock</span>)<span class="keyword">this</span>.responseMap.get(appAttemptId);</div><div class="line">        <span class="keyword">if</span>(lock == <span class="literal">null</span>) &#123;</div><div class="line">            <span class="type">String</span> message = <span class="string">"Application attempt "</span> + appAttemptId + <span class="string">" doesn\'t exist in ApplicationMasterService cache."</span>;</div><div class="line">            <span class="type">LOG</span>.error(message);</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">ApplicationAttemptNotFoundException</span>(message);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            synchronized(lock) &#123;</div><div class="line">                <span class="type">AllocateResponse</span> lastResponse = lock.getAllocateResponse();</div><div class="line">                <span class="type">String</span> filteredProgress1;</div><div class="line">                <span class="keyword">if</span>(!<span class="keyword">this</span>.hasApplicationMasterRegistered(appAttemptId)) &#123;</div><div class="line">                    filteredProgress1 = <span class="string">"AM is not registered for known application attempt: "</span> + appAttemptId + <span class="string">" or RM had restarted after AM registered . AM should re-register."</span>;</div><div class="line">                    <span class="type">LOG</span>.info(filteredProgress1);</div><div class="line">                    <span class="type">RMAuditLogger</span>.logFailure(((<span class="type">RMApp</span>)<span class="keyword">this</span>.rmContext.getRMApps().get(appAttemptId.getApplicationId())).getUser(), <span class="string">"App Master Heartbeats"</span>, <span class="string">""</span>, <span class="string">"ApplicationMasterService"</span>, filteredProgress1, applicationId, appAttemptId);</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">ApplicationMasterNotRegisteredException</span>(filteredProgress1);</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span>(request.getResponseId() + <span class="number">1</span> == lastResponse.getResponseId()) &#123;</div><div class="line">                    <span class="keyword">return</span> lastResponse;</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span>(request.getResponseId() + <span class="number">1</span> &lt; lastResponse.getResponseId()) &#123;</div><div class="line">                    filteredProgress1 = <span class="string">"Invalid responseId in AllocateRequest from application attempt: "</span> + appAttemptId + <span class="string">", expect responseId to be "</span> + (lastResponse.getResponseId() + <span class="number">1</span>);</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">InvalidApplicationMasterRequestException</span>(filteredProgress1);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    float filteredProgress = request.getProgress();</div><div class="line">                    <span class="keyword">if</span>(!<span class="type">Float</span>.isNaN(filteredProgress) &amp;&amp; filteredProgress != <span class="number">-1.0</span>F / <span class="number">0.0</span> &amp;&amp; filteredProgress &gt;= <span class="number">0.0</span>F) &#123;</div><div class="line">                        <span class="keyword">if</span>(filteredProgress &gt; <span class="number">1.0</span>F || filteredProgress == <span class="number">1.0</span>F / <span class="number">0.0</span>) &#123;</div><div class="line">                            request.setProgress(<span class="number">1.0</span>F);</div><div class="line">                        &#125;</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        request.setProgress(<span class="number">0.0</span>F);</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="keyword">this</span>.rmContext.getDispatcher().getEventHandler().handle(<span class="keyword">new</span> <span class="type">RMAppAttemptStatusupdateEvent</span>(appAttemptId, request.getProgress()));</div><div class="line">                    <span class="type">List</span> ask = request.getAskList();</div><div class="line">                    <span class="type">List</span> release = request.getReleaseList();</div><div class="line">                    <span class="type">ResourceBlacklistRequest</span> blacklistRequest = request.getResourceBlacklistRequest();</div><div class="line">                    <span class="type">List</span> blacklistAdditions = blacklistRequest != <span class="literal">null</span>?blacklistRequest.getBlacklistAdditions():<span class="type">Collections</span>.<span class="type">EMPTY_LIST</span>;</div><div class="line">                    <span class="type">List</span> blacklistRemovals = blacklistRequest != <span class="literal">null</span>?blacklistRequest.getBlacklistRemovals():<span class="type">Collections</span>.<span class="type">EMPTY_LIST</span>;</div><div class="line">                    <span class="type">RMApp</span> app = (<span class="type">RMApp</span>)<span class="keyword">this</span>.rmContext.getRMApps().get(applicationId);</div><div class="line">                    <span class="type">ApplicationSubmissionContext</span> asc = app.getApplicationSubmissionContext();</div><div class="line">                    <span class="type">Iterator</span> allocation = ask.iterator();</div><div class="line"></div><div class="line">                    <span class="keyword">while</span>(allocation.hasNext()) &#123;</div><div class="line">                        <span class="type">ResourceRequest</span> appAttempt = (<span class="type">ResourceRequest</span>)allocation.next();</div><div class="line">                        <span class="keyword">if</span>(<span class="literal">null</span> == appAttempt.getNodeLabelExpression() &amp;&amp; <span class="string">"*"</span>.equals(appAttempt.getResourceName())) &#123;</div><div class="line">                            appAttempt.setNodeLabelExpression(asc.getNodeLabelExpression());</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        <span class="type">RMServerUtils</span>.normalizeAndValidateRequests(ask, <span class="keyword">this</span>.rScheduler.getMaximumResourceCapability(), app.getQueue(), <span class="keyword">this</span>.rScheduler, <span class="keyword">this</span>.rmContext);</div><div class="line">                    &#125; <span class="keyword">catch</span> (<span class="type">InvalidResourceRequestException</span> var31) &#123;</div><div class="line">                        <span class="type">LOG</span>.warn(<span class="string">"Invalid resource ask by application "</span> + appAttemptId, var31);</div><div class="line">                        <span class="keyword">throw</span> var31;</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        <span class="type">RMServerUtils</span>.validateBlacklistRequest(blacklistRequest);</div><div class="line">                    &#125; <span class="keyword">catch</span> (<span class="type">InvalidResourceBlacklistRequestException</span> var30) &#123;</div><div class="line">                        <span class="type">LOG</span>.warn(<span class="string">"Invalid blacklist request by application "</span> + appAttemptId, var30);</div><div class="line">                        <span class="keyword">throw</span> var30;</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="keyword">if</span>(!app.getApplicationSubmissionContext().getKeepContainersAcrossApplicationAttempts()) &#123;</div><div class="line">                        <span class="keyword">try</span> &#123;</div><div class="line">                            <span class="type">RMServerUtils</span>.validateContainerReleaseRequest(release, appAttemptId);</div><div class="line">                        &#125; <span class="keyword">catch</span> (<span class="type">InvalidContainerReleaseException</span> var29) &#123;</div><div class="line">                            <span class="type">LOG</span>.warn(<span class="string">"Invalid container release by application "</span> + appAttemptId, var29);</div><div class="line">                            <span class="keyword">throw</span> var29;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="type">Allocation</span> allocation1 = <span class="keyword">this</span>.rScheduler.allocate(appAttemptId, ask, release, blacklistAdditions, blacklistRemovals);</div><div class="line">                    <span class="keyword">if</span>(!blacklistAdditions.isEmpty() || !blacklistRemovals.isEmpty()) &#123;</div><div class="line">                        <span class="type">LOG</span>.info(<span class="string">"blacklist are updated in Scheduler.blacklistAdditions: "</span> + blacklistAdditions + <span class="string">", "</span> + <span class="string">"blacklistRemovals: "</span> + blacklistRemovals);</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="type">RMAppAttempt</span> appAttempt1 = app.getRMAppAttempt(appAttemptId);</div><div class="line">                    <span class="type">AllocateResponse</span> allocateResponse = (<span class="type">AllocateResponse</span>)<span class="keyword">this</span>.recordFactory.newRecordInstance(<span class="type">AllocateResponse</span>.<span class="keyword">class</span>);</div><div class="line">                    <span class="keyword">if</span>(!allocation1.getContainers().isEmpty()) &#123;</div><div class="line">                        allocateResponse.setNMTokens(allocation1.getNMTokens());</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="type">ArrayList</span> updatedNodes = <span class="keyword">new</span> <span class="type">ArrayList</span>();</div><div class="line">                    <span class="keyword">if</span>(app.pullRMNodeUpdates(updatedNodes) &gt; <span class="number">0</span>) &#123;</div><div class="line">                        <span class="type">ArrayList</span> nextMasterKey = <span class="keyword">new</span> <span class="type">ArrayList</span>();</div><div class="line">                        <span class="type">Iterator</span> appAttemptImpl = updatedNodes.iterator();</div><div class="line"></div><div class="line">                        <span class="keyword">while</span>(appAttemptImpl.hasNext()) &#123;</div><div class="line">                            <span class="type">RMNode</span> amrmToken = (<span class="type">RMNode</span>)appAttemptImpl.next();</div><div class="line">                            <span class="type">SchedulerNodeReport</span> schedulerNodeReport = <span class="keyword">this</span>.rScheduler.getNodeReport(amrmToken.getNodeID());</div><div class="line">                            <span class="type">Resource</span> used = <span class="type">BuilderUtils</span>.newResource(<span class="number">0</span>, <span class="number">0</span>);</div><div class="line">                            int numContainers = <span class="number">0</span>;</div><div class="line">                            <span class="keyword">if</span>(schedulerNodeReport != <span class="literal">null</span>) &#123;</div><div class="line">                                used = schedulerNodeReport.getUsedResource();</div><div class="line">                                numContainers = schedulerNodeReport.getNumContainers();</div><div class="line">                            &#125;</div><div class="line"></div><div class="line">                            <span class="type">NodeId</span> nodeId = amrmToken.getNodeID();</div><div class="line">                            <span class="type">NodeReport</span> report = <span class="type">BuilderUtils</span>.newNodeReport(nodeId, amrmToken.getState(), amrmToken.getHttpAddress(), amrmToken.getRackName(), used, amrmToken.getTotalCapability(), numContainers, amrmToken.getHealthReport(), amrmToken.getLastHealthReportTime(), amrmToken.getNodeLabels());</div><div class="line">                            nextMasterKey.add(report);</div><div class="line">                        &#125;</div><div class="line"></div><div class="line">                        allocateResponse.setUpdatedNodes(nextMasterKey);</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    allocateResponse.setAllocatedContainers(allocation1.getContainers());</div><div class="line">                    allocateResponse.setCompletedContainersStatuses(appAttempt1.pullJustFinishedContainers());</div><div class="line">                    allocateResponse.setResponseId(lastResponse.getResponseId() + <span class="number">1</span>);</div><div class="line">                    allocateResponse.setAvailableResources(allocation1.getResourceLimit());</div><div class="line">                    allocateResponse.setNumClusterNodes(<span class="keyword">this</span>.rScheduler.getNumClusterNodes());</div><div class="line">                    allocateResponse.setPreemptionMessage(<span class="keyword">this</span>.generatePreemptionMessage(allocation1));</div><div class="line">                    <span class="type">MasterKeyData</span> nextMasterKey1 = <span class="keyword">this</span>.rmContext.getAMRMTokenSecretManager().getNextMasterKeyData();</div><div class="line">                    <span class="keyword">if</span>(nextMasterKey1 != <span class="literal">null</span> &amp;&amp; nextMasterKey1.getMasterKey().getKeyId() != amrmTokenIdentifier.getKeyId()) &#123;</div><div class="line">                        <span class="type">RMAppAttemptImpl</span> appAttemptImpl1 = (<span class="type">RMAppAttemptImpl</span>)appAttempt1;</div><div class="line">                        <span class="type">Token</span> amrmToken1 = appAttempt1.getAMRMToken();</div><div class="line">                        <span class="keyword">if</span>(nextMasterKey1.getMasterKey().getKeyId() != appAttemptImpl1.getAMRMTokenKeyId()) &#123;</div><div class="line">                            <span class="type">LOG</span>.info(<span class="string">"The AMRMToken has been rolled-over. Send new AMRMToken back to application: "</span> + applicationId);</div><div class="line">                            amrmToken1 = <span class="keyword">this</span>.rmContext.getAMRMTokenSecretManager().createAndGetAMRMToken(appAttemptId);</div><div class="line">                            appAttemptImpl1.setAMRMToken(amrmToken1);</div><div class="line">                        &#125;</div><div class="line"></div><div class="line">                        allocateResponse.setAMRMToken(org.apache.hadoop.yarn.api.records.<span class="type">Token</span>.newInstance(amrmToken1.getIdentifier(), amrmToken1.getKind().toString(), amrmToken1.getPassword(), amrmToken1.getService().toString()));</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    lock.setAllocateResponse(allocateResponse);</div><div class="line">                    <span class="keyword">return</span> allocateResponse;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><h3 id="Yarn-Cluster模式"><a href="#Yarn-Cluster模式" class="headerlink" title="Yarn-Cluster模式"></a>Yarn-Cluster模式</h3><p><strong> 客户端操作：</strong></p>
<ol>
<li>SparkSubmit中根据yarnConf来初始化yarnClient，并启动yarnClient </li>
<li>创建客户端Application，并获取Application的ID，进一步判断集群中的资源是否满足executor和ApplicationMaster申请的资源，如果不满足则抛出IllegalArgumentException； </li>
<li>设置资源、环境变量：其中包括了设置Application的Staging目录、准备本地资源（jar文件、log4j.properties）、设置Application其中的环境变量、创建Container启动的Context等； </li>
<li>设置Application提交的Context，包括设置应用的名字、队列、AM的申请的Container、标记该作业的类型为spark； </li>
<li>申请Memory，最终通过submitApplication方法向ResourceManager提交该Application。当作业提交到YARN上之后，客户端就没事了，会关闭此进程，因为整个作业运行在YARN集群上进行，运行的结果将会保存到HDFS或者日志中。</li>
</ol>
<p><strong> Yarn操作：</strong></p>
<ol>
<li>运行ApplicationMaster的run方法； </li>
<li>设置好相关的环境变量； </li>
<li>创建amClient，并启动； </li>
<li>在Spark UI启动之前设置Spark UI的AmIpFilter； </li>
<li>在startUserClass函数专门启动了一个线程（名称为Driver的线程）来启动用户提交的Application，也就是启动了Driver。在Driver中将会初始化SparkContext； </li>
<li>等待SparkContext初始化完成，最多等待spark.yarn.applicationMaster.waitTries次数（默认为10），如果等待了的次数超过了配置的，程序将会退出；否则用SparkContext初始化yarnAllocator；<br> 6.1. <strong>怎么知道SparkContext初始化完成?</strong><br> 其实在5步骤中启动Application的过程中会初始化SparkContext，在初始化SparkContext的时候将会创建YarnClusterScheduler，在SparkContext初始化完成的时候，会调用YarnClusterScheduler类中的postStartHook方法，而该方法会通知ApplicationMaster已经初始化好了SparkContext<br> 6.2. <strong>为何要等待SparkContext初始化完成？</strong><br> CoarseGrainedExecutorBackend启动后需要向CoarseGrainedSchedulerBackend注册  </li>
<li>当SparkContext初始化完成的时候，通过amClient向ResourceManager注册ApplicationMaster  </li>
<li>分配并启动Executeors。在启动Executeors之前，先要通过yarnAllocator获取到numExecutors个Container，然后在Container中启动Executeors。如果在启动Executeors的过程中失败的次数达到了maxNumExecutorFailures的次数，那么这个Application将失败，将Application Status标明为FAILED，并将关闭SparkContext。其实，启动Executeors是通过ExecutorRunnable实现的，而ExecutorRunnable内部是启动CoarseGrainedExecutorBackend的，CoarseGrainedExecutorBackend启动后会向SchedulerBackend注册。<br> (resourceManager是如何决定该分配几个container？  在shell提交时跟参数 默认启动两个executor)  </li>
<li>最后，Task将在CoarseGrainedExecutorBackend里面运行，然后运行状况会通过Akka通知CoarseGrainedScheduler，直到作业运行完成。</li>
</ol>
<h3 id="Client模式"><a href="#Client模式" class="headerlink" title="Client模式:"></a>Client模式:</h3><p><strong> 客户端操作：</strong></p>
<ol>
<li>通过SparkSubmit类的launch的函数直接调用作业的main函数（通过反射机制实现），如果是集群模式就会调用Client的main函数。 </li>
<li>而应用程序的main函数一定都有个SparkContent，并对其进行初始化； </li>
<li>在SparkContent初始化中将会依次做如下的事情：设置相关的配置、注册MapOutputTracker、BlockManagerMaster、BlockManager，创建taskScheduler和dagScheduler；其中比较重要的是创建taskScheduler和dagScheduler。在创建taskScheduler的时候会根据我们传进来的master来选择Scheduler和SchedulerBackend。由于我们选择的是yarn-client模式，程序会选择YarnClientClusterScheduler和YarnClientSchedulerBackend，并将YarnClientSchedulerBackend的实例初始化YarnClientClusterScheduler，上面两个实例的获取都是通过反射机制实现的，YarnClientSchedulerBackend类是CoarseGrainedSchedulerBackend类的子类，YarnClientClusterScheduler是TaskSchedulerImpl的子类，仅仅重写了TaskSchedulerImpl中的getRackForHost方法。 </li>
<li>初始化完taskScheduler后，将创建dagScheduler，然后通过taskScheduler.start()启动taskScheduler，而在taskScheduler启动的过程中也会调用SchedulerBackend的start方法。在SchedulerBackend启动的过程中将会初始化一些参数，封装在ClientArguments中，并将封装好的ClientArguments传进Client类中，并client.submitApplication()方法获取Application ID。</li>
</ol>
<p><strong> Yarn操作：</strong></p>
<ol>
<li>运行ApplicationMaster的run方法（runExecutorLauncher）； </li>
<li>无需等待SparkContext初始化完成（因为YarnClientClusterScheduler已启动完成），向sparkYarnAM注册该Application </li>
<li>分配Executors，这里面的分配逻辑和yarn-cluster里面类似，就不再说了。 </li>
<li>最后，Task将在CoarseGrainedExecutorBackend里面运行，然后运行状况会通过Akka通知CoarseGrainedScheduler，直到作业运行完成。 </li>
<li>在作业运行的时候，YarnClientSchedulerBackend会每隔1秒通过client获取到作业的运行状况，并打印出相应的运行信息，当Application的状态是FINISHED、FAILED和KILLED中的一种，那么程序将退出等待。 </li>
<li>最后有个线程会再次确认Application的状态，当Application的状态是FINISHED、FAILED和KILLED中的一种，程序就运行完成，并停止SparkContext。整个过程就结束了。</li>
</ol>
<h3 id="Yarn的ApplicationMaster管理"><a href="#Yarn的ApplicationMaster管理" class="headerlink" title="Yarn的ApplicationMaster管理"></a>Yarn的ApplicationMaster管理</h3><ol>
<li>client向RM提交程序(包含AM程序， AM启动命令，用户程序)；</li>
<li>RM向资源调度器去申请资源，一旦申请的AM需要的资源，AM Laucher 便与对应的NodeManager联系启动</li>
<li>AM同时向AM LivenessMonitor添加进监控列表，启动对AM的监控</li>
<li>AM启动后，向AM Service注册报告自己的端口号，ip，track url等,之后AM会定期向AM Service发送心跳，执行allocate，AM Service会向AM LivenessMonitor更新AM的心跳时间</li>
<li>当用户程序执行完毕，AM向AM Service报告完成，AM Service通知AM LivenessMonitor从监控列表中删除AM，释放资源。</li>
</ol>
<h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference:"></a>Reference:</h3><ol>
<li><a href="http://blog.itpub.net/29754888/viewspace-1815323/" target="_blank" rel="external">Spark on Yarn 任务提交流程源码分析</a></li>
<li><a href="http://www.tuicool.com/articles/UBfqqaE" target="_blank" rel="external">Yarn的ApplicationMaster管理</a></li>
<li><a href="http://blog.csdn.net/suifeng3051/article/details/49486927" target="_blank" rel="external">Hadoop Yarn详解</a></li>
</ol>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Spark/" rel="tag"># Spark</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/09/24/spark-common-problems-solutions/" rel="next" title="spark常见问题解决方法">
                <i class="fa fa-chevron-left"></i> spark常见问题解决方法
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/09/25/spark-rpc/" rel="prev" title="Spark Netty Rpc">
                Spark Netty Rpc <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/avatar.jpg"
               alt="sj_mei" />
          <p class="site-author-name" itemprop="name">sj_mei</p>
           
              <p class="site-description motion-element" itemprop="description">BigData & ML & DL</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">18</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">16</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/msjbear" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.linkedin.com/in/sj-mei-464b6a10b" target="_blank" title="Linkedin">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  Linkedin
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/u/1908202311" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  Weibo
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://blog.csdn.net/you12345678901234567" target="_blank" title="CSDN">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  CSDN
                </a>
              </span>
            
          
        </div>

        
        

        
        
		
		<div id="music163player">
			<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=280 height=86 src="//music.163.com/outchain/player?type=2&id=38592976&auto=1&height=66">
			</iframe>
		</div>
        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#spark-submit启动脚本："><span class="nav-number">1.</span> <span class="nav-text">spark-submit启动脚本：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#deploy-SparkSubmit代码："><span class="nav-number">2.</span> <span class="nav-text">deploy.SparkSubmit代码：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#deploy-yarn-Client代码："><span class="nav-number">3.</span> <span class="nav-text">deploy.yarn.Client代码：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#yarn-client-api-impl-YarnClientImpl代码："><span class="nav-number">4.</span> <span class="nav-text">yarn.client.api.impl.YarnClientImpl代码：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#deploy-yarn-ApplicationMaster代码："><span class="nav-number">5.</span> <span class="nav-text">deploy.yarn.ApplicationMaster代码：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#YarnRMClient"><span class="nav-number">6.</span> <span class="nav-text">YarnRMClient</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#YarnAllocator"><span class="nav-number">7.</span> <span class="nav-text">YarnAllocator</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">8.</span> <span class="nav-text">总结</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Yarn-Cluster模式"><span class="nav-number">8.1.</span> <span class="nav-text">Yarn-Cluster模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Client模式"><span class="nav-number">8.2.</span> <span class="nav-text">Client模式:</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Yarn的ApplicationMaster管理"><span class="nav-number">8.3.</span> <span class="nav-text">Yarn的ApplicationMaster管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Reference"><span class="nav-number">8.4.</span> <span class="nav-text">Reference:</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">sj_mei</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>


        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  
    
    <script>
      var cloudTieConfig = {
        url: document.location.href, 
        sourceId: "",
        productKey: "66d2daa6e86846e58f32ecacfa005078",
        target: "cloud-tie-wrapper"
      };
    </script>
    <script src="https://img1.ws.126.net/f2e/tie/yun/sdk/loader.js"></script>
  










  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("7DisX00Rz2MgtyIeEsJJSxSa-gzGzoHsz", "F35WwJxNcP2TEfBs5KVTPSiA");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  

  

  

</body>
</html>
